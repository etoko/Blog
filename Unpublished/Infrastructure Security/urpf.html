 
<p>
Unicast Reverse Path Forwarding (URPF) can be used to limit malicious traffic in
a network by blocking packets passing through the router having spoofed or malformed
source IP addresses. It does this by checking the source IP address of packets 
arriving on an interface and determining whether the network of the source IP 
address is reachable using Layer 2 information in the Forwarding Information Base
(FIB). The FIB is generated by Cisco Express Forwarding (CEF). If the network of 
the packet source IP address is not reachable, the packet is dropped.
</p>
<p>
Before configuration of URPF, a router checks reachability of a destination a
ddress prior to forwarding a packet. With URPF, the router validates reachability 
of the source IP address as well. URPF can be configured to verify whether the 
interface through which the packets entering the router is what the router would
normally use to send traffic back to IP addresses in that network.

For URPF to function, CEF must be enabled globally (using the global configuration command ip cef)
</p>

<h1>Network Configuration for URPF</h1>
<p>
When configuring URPF, on a router, it is recommended that the following associated configurations be made as well;
<ol>
  <li>Configure ACLs to drop packets packets that have invalid source addresses 
  (ingress filtering)</li>
  <li>Configure ACLs to permit packets that fail the URPF checks to allow specific 
  traffic from known asymmetric routed sources.</li>
  <li>Configure ACLs to track URPF events by adding the logging option to the ACL. 
  This logging of denied or forwarded (suppressed drops) can provide additional 
  information about network attacks.</li>
</ol>
</p>
<h1>Restrictions to URPF</h1>
<p>
Basic restrictions to applying URPF;
<ul>
 <li>Clients should not be multi-homed to the same router.</li>
 <li>Ensure that packets flowing up the link (to the Internet) match the route 
 advertised out the link.</li>
 <li>URPF is available on platforms that support CEF.</li>
</ul>
URPF is important particularly in ISPs.
</p>

<h1>How URPF Works</h1>
<p>
The URPF feature helps to mitigate problems caused by the introduction of malformed
or forged/spoofed IP source addresses into a network by discarding IP packets that 
lack a verifiable IP source address. A number of common Denial-of-Service (DoS) 
attacks such as smurf attacks, tribal Flood Network (TFN) attacks take advantage 
of forged or rapidly changing source address.
</p>
<p>
URPF depends on CEF being enabled because the lookup relies on the FIB which is 
generated by CEF. URPF is an input function and is applied only on the input
interface of a router at the upstream end of a connection.
</p>
<p>
URPF checks to see if any packet received at a router interface arrives on the 
best return path to the source of the packet. URPF does this by carrying out a 
reverse lookup in the CEF table. If the packet is received from one of the reverse
path routes, the packet is forwarded as normal.
</p>
<p>
If a reverse path for the packet is not found, the packet is dropped or forwarded 
depending on whether an ACL is specified in the URF configuration.
</p>
<p>
With URPF, all equal cost return paths are considered valid. URPF works in cases 
where multiple return paths exist provided that each path is equal to others in 
terms of routing cost, i.e. number of hops, weight etc.and as long as the route 
is in the FIB. URPF also functions where EIGRP variants are being used with unequal 
cost routes back to the packet source IP address.
</p>

<h1>Unicast RPF Operation Modes</h1>
<p>
URPF operates in three modes; strict, loose and VRF modes. Some modes may not be 
available on some Cisco router models.
<ol>
    <li><b>Strict mode:</b> URPF checks to make sure that the source IP address 
    is reachable based on the FIB table and the packet must also be arriving on 
    the same interface that the router would use to send traffic back to that IP
    address.
    Strict mode should only be used in conditions where no possibility of asynchronous 
    routing exists or else packets will be dropped. This is likely to occur in 
    BGP routing.</li>
    <li><b>Loose mode:</b> The router only verifies that the source IP address is
    reachable based on the FIB entry. The default route or route through the interface 
    Null0 are not included in this reachability check. If the route is not in the 
    RIB, the packet is dropped.</li>
    <li><b>VRF mode:</b> This mode is similar to loose mode operation but is 
    deployed in VRF environments. Interfaces in the same VRF as the receiving 
    interface are examined. This is commonly used in ISP networks for MPLS and BGP.</li>
</ol>
</p>
<p>
By default, URPF drops packets whose source IP address/network is reachable only 
via the default route. URPF supports ‘allow-default’ to accept a default route as
a valid route.
</p>
<p>
If an ACL is referenced in the URPF configuration, it is checked when URPF fails. 
If URPF check fails and the packet is permitted by an ACL, it is transmitted. 
If the ACL is configured to block the traffic the packet is dropped after URFP 
failure.
</p>

<h1>URPF Configuration</h1>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
  <code style="font-size:130%">
R1(config)#interface g0/0
R1(config-if)#ip verify unicast source reachable-via rx | any &lt;allow-default&gt; &lt;allow-self-ping&gt; &lt;ACL&gt;
</code></div></p>

<p>
Configuration Options;
<ul>
<li><b>rx:</b> enables strict mode</li>
<li><b>any:</b> enables loose mode</li>
<li><b>allow-default:</b> allows the use of a default route. It can be used in 
strict mode or loose mode.</li>
<li><b>allow-self-ping:</b> allows self-pinging when checking reachability of IP 
address. Cisco specifically discourages configuration of URPF with allow-self-ping 
as it introduced security loopholes with possibility of Denial of Service (DoS) attacks.</li>
</ul>
Do not configure strict mode on an uplink interface. Loose mode may be more appropriate in these case.
</p>

<h1>Verification</h1>
<p>
<h2><code>show cef interface gigabitethernet0/0</code></h2> 
<h2><code>show ip traffic </code></h2>
<h2><code>show run interface gigabitethernet0/0</code></h2>  
<h2><code>show ip verify statistics</code></h2>
<p>
(Provides URPF statistics on a PIX | ASA | FWSM firewall
</p>

<h1>Access Control Lists and Logging</h1>
<p>
If a packet fails the URPF check, URPF checks the linked ACL to see if the packet 
should be dropped (ACL deny statement) or forwarded (permit statement). Regardless
of whether the packet is dropped or forwarded, the packet is counted in global IP 
traffic statistics for unicast drops and in interface statistics for URPF. To log 
URPF events, specify the logging option for the ACL ACE. Using log info, administrators 
can view source addresses that are used in the attack, the time at which packets 
arrived on an interface.
</p>
<p>
<b>Note:</b> Logging URPF events for attacks that have a high rate of forged 
packets can degrade performance of the device.

<h1>Per-Interface Statistics</h1>
<p>
Per-inteface statistics allow tracking of URPF drops and URPF suppressed drops. 
These statistics help identify the interface that is the entry point of the attacks.
Unicast suppressed drops are the count of packets that failed URPF check but were 
permitted by ACLs.
</p>

<h1>Implementing Unicast RPF</h1>
<p>
URPF implementation principles;
<ol>
  <li>Packets must be received on an interface that has the best return path to 
  the source (symmetric routing). There must be a router in the FIB matching the
  route to the receiving interface. ACLs permit URPF to be used when packets are 
  known to be arriving by specific, less optimal asymmetric input paths.</li>
  <li>IP source addresses at the receiving interface must match the routing entry
  for the interface.</li>
  <li>URPF is an input function and is applied only on the input interface of a 
  router at the upstream end of the network. </li>
</ol>
    </p>

<h1>Where to use URPF</h1>
<p>
URPF does not inspect IP packets encapsulated in tunnels such as GRE, L2TP, PPTP.
Configure URPF so that it processes network traffic only after tunneling and 
encryption headers have been stripped from the packets.

URPF can be used in any single-homed environment (symmetric routing). In such a 
case, URPF is best used at the network perimeter for Internet, intranet and extranet.

URPF on an ingress interface from the Internet protects an enterprise from packets
with malformed or spoofed source IP addresses from the Internet. If implemented 
in an ISP, it protects the ISP from spoofed packets from an enterprise.
</p>