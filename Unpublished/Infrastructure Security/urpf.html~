 
<p>
Unicast Reverse Path Forwarding (URPF) can be used to limit malicious traffic in a network by blocking packets passing through the router having spoofed or malformed source IP addresses. It does this by checking the source IP address of packets arriving on an interface and determining whether the network of the source IP address is reachable using Layer 2 information in the Forwarding Information Base (FIB). The FIB is generated by Cisco Express Forwarding (CEF). If the network of the packet source IP address is not reachable, the packet is dropped.

Before configuration of URPF, a router checks reachability of a destination address prior to forwarding a packet. With URPF, the router validates reachability of the source IP address as well. URPF can be configured to verify whether the interface through which the packets entering the router is what the router would normally use to send traffic back to IP addresses in that network.

For URPF to function, CEF must be enabled globally (using the global configuration command ip cef)

<h1>Network Configuration for URPF</h1>

When configuring URPF, on a router, it is recommended that the following associated configurations be made as well;

    Configure ACLs to drop packets packets that have invalid source addresses (ingress filtering)
    Configure ACLs to permit packets that fail the URPF checks to allow specific traffic from known asymmetric routed sources.
    Configure ACLs to track URPF events by adding the logging option to the ACL. This logging of denied or forwarded (suppressed drops) can provide additional information about network attacks.

Restrictions to URPF

Basic restrictions to applying URPF;

    Clients should not be multi-homed to the same router.
    Ensure that packets flowing up the link (to the Internet) match the route advertised out the link.
    URPF is available on platforms that support CEF.

URPF is important particularly in ISPs.

How URPF Works

The URPF feature helps to mitigate problems caused by the introduction of malformed or forged/spoofed IP source addresses into a network by discarding IP packets that lack a verifiable IP source address. A number of common Denial-of-Service (DoS) attacks such as smurf attacks, tribal Flood Network (TFN) attacks take advantage of forged or rapidly changing source address.

URPF depends on CEF being enabled because the lookup relies on the FIB which is generated by CEF. URPF is an input function and is applied only on the input interface of a router at the upstream end of a connection.

URPF checks to see if any packet received at a router interface arrives on the best return path to the source of the packet. URPF does this by carrying out a reverse lookup in the CEF table. If the packet is received from one of the reverse path routes, the packet is forwarded as normal.

If a reverse path for the packet is not found, the packet is dropped or forwarded depending on whether an ACL is specified in the URF configuration.

With URPF, all equal cost return paths are considered valid. URPF works in cases where multiple return paths exist provided that each path is equal to others in terms of routing cost, i.e. number of hops, weight etc.and as long as the route is in the FIB. URPF also functions where EIGRP variants are being used with unequal cost routes back to the packet source IP address.
Unicast RPF Operation Modes

URPF operates in three modes; strict, loose and VRF modes. Some modes may not be available on some Cisco router models.

    Strict mode: URPF checks to make sure that the source IP address is reachable based on the FIB table and the packet must also be arriving on the same interface that the router would use to send traffic back to that IP address.
    Strict mode should only be used in conditions where no possibility of asynchronous routing exists or else packets will be dropped. This is likely to occur in BGP routing.

    Loose mode: The router only verifies that the source IP address is reachable based on the FIB entry. The default route or route through the interface Null0 are not included in this reachability check. If the route is not in the RIB, the packet is dropped.

    VRF mode: This mode is similar to loose mode operation but is deployed in VRF environments. Interfaces in the same VRF as the receiving interface are examined. This is commonly used in ISP networks for MPLS and BGP.

By default, URPF drops packets whose source IP address/network is reachable only via the default route. URPF supports ‘allow-default’ to accept a default route as a valid route.

If an ACL is referenced in the URPF configuration, it is checked when URPF fails. If URPF check fails and the packet is permitted by an ACL, it is transmitted. If the ACL is configured to block the traffic the packet is dropped after URFP failure.
URPF Configuration

R1(config)#interface g0/0
R1(config-if)#ip verify unicast source reachable-via rx | any <allow-default> <allow-self-ping> <ACL>

Configuration Options;

rx: enables strict mode

any: enables loose mode

allow-default: allows the use of a default route. It can be used in strict mode or loose mode.

allow-self-ping: allows self-pinging when checking reachability of IP address. Cisco specifically discourages configuration of URPF with allow-self-ping as it introduced security loopholes with possibility of Denial of Service (DoS) attacks.

Do not configure strict mode on an uplink interface. Loose mode may be more appropriate in these case.
Verification

R1# show cef interface gigabitethernet0/0 

R1# show ip traffic 

R1# show run interface gigabitethernet0/0  

R1# show ip verify statistics   (Provides URPF statistics on a PIX | ASA | FWSM firewall.

Access Control Lists and Logging

If a packet fails the URPF check, URPF checks the linked ACL to see if the packet should be dropped (ACL deny statement) or forwarded (permit statement). Regardless of whether the packet is dropped or forwarded, the packet is counted in global IP traffic statistics for unicast drops and in interface statistics for URPF. To log URPF events, specify the logging option for the ACL ACE. Using log info, administrators can view source addresses that are used in the attack, the time at which packets arrived on an interface.

Note: Logging URPF events for attacks that have a high rate of forged packets can degrade performance of the device.
Per-Interface Statistics

Per-inteface statistics allow tracking of URPF drops and URPF suppressed drops. These statistics help identify the interface that is the entry point of the attacks. Unicast suppressed drops are the count of packets that failed URPF check but were permitted by ACLs.
Implementing Unicast RPF

URPF implementation principles;

    Packets must be received on an interface that has the best return path to the source (symmetric routing). There must be a router in the FIB matching the route to the receiving interface. ACLs permit URPF to be used when packets are known to be arriving by specific, less optimal asymmetric input paths.
    IP source addresses at the receiving interface must match the routing entry for the interface.
    URPF is an input function and is applied only on the input interface of a router at the upstream end of the network. 

Where to use URPF

URPF does not inspect IP packets encapsulated in tunnels such as GRE, L2TP, PPTP. Configure URPF so that it processes network traffic only after tunneling and encryption headers have been stripped from the packets.

URPF can be used in any single-homed environment (symmetric routing). In such a case, URPF is best used at the network perimeter for Internet, intranet and extranet.

URPF on an ingress interface from the Internet protects an enterprise from packets with malformed or spoofed source IP addresses from the Internet. If implemented in an ISP, it protects the ISP from spoofed packets from an enterprise. 