<h1>Configuring Dynamic Multipoint Virtual Private Network (DMVPN)</h1>

<h1>Introduction</h1>
<p>
DMVPN is a Cisco developed technology used in enterprise networks to create 
Virtual Private Networks (VPNs) to interconnect an enterprise’s various 
geographically separated offices over a public network such as the Internet. 
The cost of implementing 
DMVPN is so much lower than the cost of installing and operating a private or 
leased Wide Area Network (WAN).
</p>
<p>
DMVPN relies on two technologies i.e. Multipoint Generic Routing Encapsulation 
(mGRE) and Next Hop Resolution Protocol (NHRP). To create DMVPNs, the following 
steps should be followed;
<ul>
  <li>Step 1: Configuration of mGRE tunnels.</li>
  <li>Step 2: Configuration of Next Hop Resolution Protocol (NHRP).</li>
  <li>Step 3: Securing the DMVPN Tunnel with IPSec.</li>
</ul>
</p>
<p>
DMVPN operates in three phases; Phase 1, Phase 2, and Phase 3. Each phase 
incrementally adds features that improve and secure the operation of DMVPN.

The following topology will be used for the configuration of DMVPN;
</p>

<h1>Multipoint Generic Routing Encapsulation Tunnels (mGRE)</h1>
<p>
mGRE creates Virtual Private Network (VPN) tunnels between routers. A hub
router is the central connection point of what is a star topology. DMVPN provides
for the capablity to create topologies that contain more than one hub. For purposes
of understanding DMVPN, we will implement a single-hub DMVPN topology.
</p>
<p>
GRE is used as a transport mechanism for protocols such as IP by encapsulating 
the IP packets. Dynamic routing protocols such as OSPF, EIGRP are supported. 
Whereas GRE supports unicast packets, the default configuration of most dynamic 
routing protocols (without optimization) is to use multicast packets. Spokes can 
be configured to send encapsulated multicast packets in unicast GRE packets to 
the hub. The tunnels created by mGRE are usually referred to as the overlay network. 
The existing transport network is referred to as the underlay network.
</p>
<p>
When network traffic is to be routed through the overlay network, a new GRE header
is added to the existing IP packet. The GRE header encapsulates the tunnel IP 
header and data. This encapsulated packet may be a multicast or unicast packet. 
This packet is then routed through the underlay network using the underlay IP 
destination address. The router at the end of the tunnel, strips the GRE header 
and routes the packet based on the previously encapsulated IP header destination 
address (for destination-based routing).
</p>
<p>
GRE tunnels support IPv4 or IPv6 addresses as underlay and/or the overlay network. 
By default, GRE does not support encryption. However, tunnel encryption can be 
added through IPSec.
</p>
<h2>Steps for the configuration of GRE Tunnels</h2>
<h3>Phase 1: Peer to Peer</h3>
<p>
Control-plane neighborships only happen between spoke and hub. Spokes are not 
able to form dynamic routing protocol neighbor relationships with each other.

All spoke to spoke communication transits the hub because hub sets itself as the
next-hop in control-plane traffic. All data plane traffic transits via the hub 
as a result.
</p>
<p>
mGRE requires the configuration of the hub and spokes. Usually the hub takes 
many more commands than those of the spokes. 
</p>

<h4>Step 1: Create the tunnel interface</h4>
<p>
The global configuration command <code><b>interface tunnel &lt;tunnel_number&gt;</b></code> is used.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
      	<code style="font-size:110%">
HUB#<b>configure terminal</b> <br>
HUB(config)#<b>interface tunnel 10</b>
</code></div>
</p>

<h4>Step 2: Identify the tunnel source</h4> 
<p>
A tunnel source is the interface whose IP address will be used as the source IP 
in the IP packets sent through the underlay network.
It is usually a good idea to specify a logical interface such as a loopback interface.
A loopback interface is always up and if a router has more than one Internet 
connection through different router interfaces, then any of the Interfaces can 
be used to route the tunnel traffic if any one interface goes down. If a loopback
interface is used, remember to advertise the configured network on this interface.
The configuration command is <code><b>#tunnel source &lt;ip_address | interface&gt;</b></code>.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
      	<code style="font-size:110%">
HUB(config-if)#<b>tunnel source loopback 0</b>
</code></div>

<h3>Hub Configuration</h3>
<p>
The following set of commands are implemented on the hub router.
</p>
<h4>Step 3: Configure the mode of the tunnel to multipoint GRE</h4>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
      	<code style="font-size:110%">
HUB(config-if)#<b>tunnel mode gre multipoint</b>
</code></div>
</p>

<h4>Step 4: Allocate an IP address to the tunnel interface</h4>
<p>
The subnet should have a sufficient number of IP addresses to be able 
to accommodate the planned number of spokes and hubs in the network. Proper 
planning during the design of the network should cater for this. For this 
example, we will accommodate a maximum of 510 hubs and clients so a subnet mask 
of 255.255.254.0 (/23) is used.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
      	<code style="font-size:110%">
HUB(config-if)#<b>ip address 10.100.100.1 255.255.254.0</b>
</code></div>
</p>

<h4>Step 5: (Optional) Define the tunnel bandwidth</h4>
<p>
The tunnel bandwidth is usually configured for routing purposes. In the tunnel 
interface configuration mode, the command is <code><b>bandwidth &lt;1 – 10000000&gt;</b></code>
The value is in kbps. The default bandwidth is 100Kbps.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>bandwidth 100000</b>
</code>
</div>
</p>

<h4> Step 6: (Optional) Specify the GRE tunnel keepalive</h4>
<p>
Keepalives ensure that bi-directional communication between tunnel end-points 
remain active. In tunnel interface mode, the command is <code><b>keepalive &lt;seconds&gt; &lt;retries&gt;</b></code>.
The default keepalive time is 10 seconds and 3 retries.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>keepalive 10 5</b>
</code>
</div>
</p>

<h4> Step 7: (Optional) Define the MTU</h4>
<p>
By default, the MTU for tunnel interfaces is 1476. The rationale behind setting 
the MTU value to 1476 is that the GRE header with a minimum size of 24 bytes is 
added to the IP packet. Together, the new MTU size of the IP packet should total 
1500. This size is supported by many network device interfaces use as the maximum 
MTU. It is recommended to specify an MTU value of 1400. In tunnel configuration 
mode, the command is <code><b>ip mtu &lt;value&gt;</b></code>.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip mtu 1400</b>
</code>
</div>
</p>

<h4>Step 8: Define the Maximum Segment Size (MSS)</h4>
<p>
This ensures that the router modifies the payload of a three-way handshake if 
the MSS exceeds the configured value. With DMVPN, this value is typically 1360.

During tunnel configuration, configure MTU to 1400, MSS to 1360 to avoid 
fragmentation by hosts.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip tcp adjust-mss 1360</b>
</code>
</div>
</p>

<h3>Spoke configuration</h3>
<p>
Configuration of the Spoke in DMVPN phase 1 is similar to the configuration of 
the hub. The only exception is that with the spoke GRE is configured instead of 
mGRE. In the configuration of the hub, replace steps 3 and 4.
</p>

<h4>Step 3: Configure the destination of the tunnel</h4>
<p>
The destination IP address should be the address of the underlay/transport 
interface of the hub;
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE7(config-if)#<b>tunnel destination 10.10.10.10</b>
</code>
</div>
</p>

<h4>Step 4: Allocate an IP address to the tunnel interface</h4>
<p>
This IP address should be in the subnet of the tunnel of the Hub
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE7(config-if)#<b>ip address 10.100.100.7 255.255.254.0</b>
</code>
</div>
</p>


<h2>Next Hop Resolution Protocol (NHRP)</h2>
<p>
NHRP is used for mapping tunnel addresses to transport (overlay) addresses. It 
is defined in RFC 2332. NHRP operates using the client-server model with a hub 
as the server and the spokes as the client. The clients are also referred to as 
Next Hop Clients (NHC) and the server as Next Hop Server (NHS).

NHCs are statically configured with the IP address of the NHCs so they can register
their tunnel and NBMA (transport) address. No manual registration of clients is 
done at the NHS. They dynamically register themselves. This is known as zero-touch 
configuration of clients at the NHS. Configuration on the spokes is similar with 
only the tunnel IP address being changed.

All NHRP packets must include; source NBMA address, source protocol address, 
destination protocol address and NHRP message type.
</p>

<h3>NHRP Message Types</h3>
<p>
These are the various types of messages NHCs and NHSs exchange with each other;
<ul>
  <li><b>Registration:</b> is sent from NHCs to NHS to all hubs to know the spoke’s NBMA 
      information along with the amount of time the registration should be maintained.</li>
  <li><b>Resolution:</b> messages to locate and provide address resolution information 
      of the egress router toward a destination. Resolution Reply provides the 
      tunnel IP address and the NBMA of the remote spoke.</li>
  <li><b>Redirect:</b> allow an intermediate router to notify the router 
  originating traffic that a specific network can be reached by a more optimal 
  path (NHC to NHC) (Phase 3). Redirect suppression messages can be sent by an 
  NHC to indicate that the redirected path is not feasible.</li>
  <li><b>Purge:</b> Sent to remove a cached NHRP entry for example after the 
  loss of a route by NHS. They are sent by NHSs to NHCs which previously requested 
  for NBMA-overlay address mapping.</li>
  <li><b>Error:</b> Used to notify the sender of an NHRP packet that an error 
  has occurred.</li>
</ul>

<h3>NHRP Extension Messages</h3>
<p>
These messages are included as an extension to an NHRP packet as shown in the image below;
<ul>
  <li><b>Responder Address:</b> To determine the address of the responding node for replies.</li>
  <li><b>Forward-Transit NHS Record and Reverse-Transit NHS Record:</b> List of 
  NHSs that an NHRP request and reply may have traversed respectively.</li>
  <li><b>Authentication:</b> conveys authentication information between a pair 
  of NHRP speakers in plain text.</li>
  <li><b>Vendor Private:</b> vendor private information between speakers.</li>
  <li><b>NAT Address:</b> DMVPN operates in NAT environment. It detects inside 
  local and inside global addresses.</li>
</ul>
  Spoke sites initiate a persistent VPN connection to the hub. DMVPN dynamically
  builds a VPN tunnel between spoke sites on an as-needed basis.
</p>

<h2>Configuration of NHRP</h2>

<h2>Hub Configuration</h2>
<p>
Continuing from the previous stages on the configuration of a hub using mGRE;
</p>
<h3>Step 9: Enable NHRP on the tunnel interface</h3>
<p>
NHRP is enabled on the tunnel using the tunnel mode command 
<code><b>ip nhrp network-id &lt;1 – 4294967295&gt;</b></code>.
Network-ID is locally significant but is recommended to match on all routers. 
It identifies the DMVPN cloud on a router. One router can participate in many 
DMVPN clouds. This ID uniquely identifies each of these clouds.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip nhrp network-id 200</b>
</code>
</div>
</p>

<h3>Step 10: (Optional) Define the tunnel key</h3>
<p>
The tunnel key is defined using the tunnel interface configuration command 
<code><b>tunnel key &lt;0 – 4294967295&gt;</b></code>. The tunnel key 
identifies the interface in the DMVPN cloud. It provides some limited control 
over the registration of NHCs with NHSs. If configured on the NHS, the tunnel key 
must match on all the connecting NHCs. This provides some control over 
misconfigurations of NHCs registering with the wrong NHS.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>tunnel key 200</b>
</code>
</div>
</p>
<p>
Configuration of the tunnel key adds an additional 4-bytes to the DMVPN header.
</p>
<h3>Step 11: (Optional) Enable multicast support for NHRP</h3>
<p>
This is important if Interior Gateway Protocols such as OSPF and EIGRP are to be
used for routing. IGPs use multicast for sending and receiving some packet
types such as Hello packets to dynamically-learned spokes.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip nhrp map multicast dynamic</b>
</code>
</div>
</p>

<h3>Step 12: (Phase 3): Enable NHRP Redirect</h3>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip nhrp redirect</b>
</code>
</div>
</p>

<h3>Step 13: (Optional) Static NHRP Mapping</h3>
<p>
Perform static NHRP mapping on the hub that specifies that the VPN address maps 
to the physical interface address using the tunnel mode command 
<code><b>ip nhrp map &lt;tunnel-ip-address&gt; &lt;interface-ip-address&gt;</b></code>.
In the following configuration, the VPN address 10.100.100.1 maps to the physical 
address of 10.1.110.10 in the underlay network.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip nhrp map 10.100.100.1 10.1.110.1</b>
</code>
</div>

<h3>Step 14: (Optional) Specify the VPN Address of the NHS</h3>
<p>
Configure the VPN address of the NHS using the command <code><b>ip nhrp nhs &lt;ip-address&gt;</b></code>.
This command explicitly specifies the NHS on the network. This command is 
required specifically if step 13 is configured. 
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip nhrp hs 10.100.100.1</b>
</code>
</div>
</p>

<h3>Step 15: (Optional) Authentication</h3>
<p>
To require spokes to authenticate with the NHS before registration or resolution 
requests can be made. The password used with NHRP authentication is stored in plain text.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip nhrp authentication simplesimple123</b>
</code>
</div>
</p>
<p>
This command helps prevent misconfiguration such as one NHC registering with 
the wrong NHS. If authentication is configured on the NHS, it must be configured 
on all NHCs with the same password.
</p>

<h2>Spoke Configuration (DMVPN Phase 1: Point to Point)</h2>
<p>
DMVPN Phase 1 creates point to point tunnels between the hub and each of the 
spokes resulting in a more traditional hub and spoke topology. For each NHC to 
communicate with any other NHC, all traffic must be sent through the hub.

Continuing the earlier configuration of mGRE on the spoke;
</p>

<h3>Step 9: Enable NHRP on the tunnel interface</h3>
<p>
NHRP is enabled using the command <code><b>ip nhrp network-id &lt;1 – 4294967295&gt;</b></code>.
The Network ID identifies the DMVPN cloud on a router. It is locally 
significant and does not have to be the same between spoke an hub but is recommended 
to match on all routers participant in the same DMVPN cloud.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>ip nhrp network-id 200</b>
</code>
</div>
</p>

<h3>Step 10: (Optional) Define the tunnel key</h3>
<p>
The command <code><b>tunnel key &lt;0 – 4294967295&gt;</b></code> is used to configure the tunnel 
key. The tunnel 
key identifies the interface in the DMVPN cloud. It provides some limited control 
over the registration of NHCs with NHSs. If configured on the NHS, the tunnel key
must match on all the connecting NHCs. This provides some control over misconfigurations of
NHCs registering with the wrong NHS.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-if)#<b>tunnel key 200</b>
</code>
</div>
</p>

<h3>Step 11: Specify the NHS NBMA address and multicast mapping</h3>
<p>
The NHS NBMA address and multicast mapping is accomplished using the command 
<code><b>ip nhrp nhs &lt;nhs_tunnel_address&gt; nbma &lt;nbma_address&gt; multicast</b></code>.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE8(config-if)#<b>ip nhrp nhs 10.100.100.1 nbma 10.10.10.10 multicast</b>
</code>
</div>
</p>
<p>
Alternative NHRP mapping commands are needed only where a static unicast or 
multicast map is needed for a node (NHC).
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
#ip nhrp nhs &lt;nhs_tunnel_address&gt;<br>
#ip nhrp map &lt;nhs_tunnel_address&gt; &lt;nhs_nbma_addr&gt;<br>
#ip nhrp map multicast &lt;nhs_nbma_addr | dynamic&gt;<br>
</code>
</div>
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE7(config-if)#<b>ip nhrp nhs 10.100.100.1</b><br>
SPOKE7(config-if)#<b>ip nhrp map 10.100.100.1 10.10.10.10</b><br>
SPOKE7(config-if)#<b>ip nhrp map multicast 10.10.10.10</b>
</code>
</div>
</p>
<p>
The value of the NBMA address of the NHS must be the same as the IP address 
configured as tunnel source IP address or specifying the tunnel 
source interface during configuring of the tunnel interface on the NHS. 
Configuring any other IP address on the NHS even if the NHC has a route to that 
interface will not activate the tunnel.
</p>

<h1 id="VERIFICATION">Verification</h1>
<p>
The NHS (HUB) should always be one hop away from the NHC through the VPN tunnel. This can 
confirmed through a traceroute to the NHS from any of the NHCs.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE7(config-if)#<b>do traceroute 10.100.100.1</b><br>
Type escape sequence to abort.                  <br>
Tracing the route to 10.100.100.1               <br>
VRF info: (vrf in name/id, vrf out name/id)     <br>
&nbsp;&nbsp;1 10.100.100.1 564 msec *  8 msec
</code>
</div>
</p>
<p>
The NHCs should be two hops away from each other with the first hop being the NHS.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE7(config-if)#<b>do traceroute 10.100.100.8</b>    <br>
Type escape sequence to abort.                  <br>
Tracing the route to 10.100.100.8               <br>
VRF info: (vrf in name/id, vrf out name/id)     <br>
&nbsp;&nbsp;1 10.100.100.1 180 msec 16 msec 56 msec       <br>
&nbsp;&nbsp;2 10.100.100.8 904 msec *  2312 msec          <br>
SPOKE7(config-if)#
</code>
</div>
</p>

<h2>Spoke Configuration (DMVPN Phase 2)</h2>
<p>
In DMVPN phase 2 operation, all spoke to spoke communication happens directly without transiting the hub. 
All routers i.e. NHCs and NHS implement multi-point GRE. A dynamic NHRP mapping 
entry appears in the NHRP table for communication with a remote spoke.

When a spoke initiates communication with a remote spoke, it sends an NHRP 
request to the hub about the remote tunnel IP. The hub sends an NHRP forward to 
the spoke (destination) indicating the source spoke NBMA and tunnel addresses. 
The destination spoke adds this mapping entry into its NHRP table /cache. The 
destination spoke then sends the source spoke an NHRP reply (unicast) with its
NBMA and tunnel addresses.
</p>
<p>
Phase 2 doesn’t support summarisation (at the hub). When summarisation occurs 
DMVPN reverts to phase 1.

In configuration of a phase 2 DMVPN tunnel, replace tunnel destination command 
with tunnel mode gre multipoint.
</p>
<p>
Replace:
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE7(config-if)#<b>tunnel destination 10.10.10.10</b>
</code>
</div>
</p>
<p>
with
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE7(config-if)#<b>tunnel mode gre multipoint</b>
</code>
</div>
</p>

<h3>Next-Hop</h3>
<p>
If EIGRP is configured as the overlay IGP, the hub does not modify the next hop. 
So the next-hop-self feature of EIGRP can be disabled at the NHS;
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config)#<b>interface tunnel0</b><br>
HUB(config-if)#<b>no ip next-hop-self eigrp 100</b>
</code>
</div>
</p>
<p>
With OSPF, the interface type should be changed to BROADCAST
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config)#<b>interface tunnel0</b><br>
HUB(config-if)#<b>ip ospf network broadcast</b>
</code>
</div>
</p>
<p>
Like OSPF, the tunnel interface in IS-IS should be configured as a BROADCAST. 
However, database synchronisation and convergence need to be complete first. 
With eBGP, third party next-hops can be used. IBGP does not modify the next-hop by default.
</p>

<h2>Spoke Configuration (DMVPN Phase 3)</h2>
<p>
In DMVPN Phase 3 configuration;
</p>

<h3>NHS</h3>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config)#<b>interface tunnel0</b><br>
HUB(config-if)#<b>ip nhrp redirect</b></br>
</code>
</div>
</p?

<h3>NHC;</h3>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE7(config)#<b>interface tunnel0</b><br>
SPOKE7(config-if)#<b>ip nhrp shortcut </b><br>
</code>
</div>
</p>
<p>
The command ip nhrp redirect on the NHS checks the flow of packets on the 
physical interface and sends a redirect message to the source spoke router when 
it detects packets hairpinning out of the DMVPN cloud. Hairpinning is when 
traffic is received and sent out of an interface in the same cloud (identified 
by the NHRP network ID). Hairpinning of traffic triggers redirect messages.

When NHC X wants to communicate with NHC Y, it sends traffic to the NHS. NHS 
sends NHRP messages to NHC Y informing NHC Y that NHC X would like to communicate 
with it. NHC Y replies with its particulars to NHS. NHS detects that it received
the reply from NHC Y through the same interface that it received the resolution 
request from NHC X (hairpining). It sends a traffic indication (redirect) message 
to NHC Y informing NHC Y that NHC X can be reached through a direct route than 
the route through NHS. NHS also sends a redirect message to NHC X indicating 
that NHC Y can be reached through a better direct route than the route through 
NHS. The redirect from the NHS is known as traffic indication.

For NHC X and NHC Y to utilise these redirect messages from NHS, they need to 
have the command ip nhrp shortcut configured on their tunnel interface.

It is important to note that in DMVPN phase 3, initial data traffic is through 
the hub only if the tunnel – NBMA address mapping is not yet in the NHRP table 
of the spokes. Subsequent traffic is direct to remote spoke.

SPOKE7(config-if)#do trace 10.100.100.8
Type escape sequence to abort.
Tracing the route to 10.100.100.8
VRF info: (vrf in name/id, vrf out name/id)
  1 10.100.100.1 36 msec 28 msec
    10.100.100.8 92 msec
SPOKE7(config-if)#do trace 10.100.100.8
Type escape sequence to abort.
Tracing the route to 10.100.100.8
VRF info: (vrf in name/id, vrf out name/id)
  1 10.100.100.8 92 msec *  92 msec
In DMVPN phase 3, if EIGRP is configured as the routing protocol over the overlay network, EIGRP, by default, changes the next-hop to the router it is running on.

In phase 3, a next-hop-self feature is usually ignored as the redirect on the NHS and shortcut on NHC will take care of spoke to spoke communication. Its presence or absence in NHS configuration is of no effect.

In phase 3, when summarisation is implemented at the hub, a more specific NHRP route (code ‘H’) is installed in the RIB to the remote spoke. The shortcut command on the spoke is required for this to be accepted. This NHRP route as an AD of 250.

It is important to note that control-plane and IP multicast traffic still go through the hub regardless of DMVPN phase. This means that if an IGP such as OSPF is configured, the NHS should be configured as the Designated Router (DR) to distribute updates to the NHCs. With EIGRP, the next-hop-self feature should be disabled in order for the Phase 3 redirects to be successful.

All neighborships of IGPs are with the NHS. NHCs cannot form IGP neighborships as they do not send multicast traffic to each other.

Verification of traffic indication;

SPOKE7#debug dmvpn all all
SPOKE7#ping 10.100.100.8
...
*Feb 14 21:44:08.387: NHRP: Receive Traffic Indication via Tunnel0 vrf 0, packet size: 84
*Feb 14 21:44:08.391:  (F) afn: AF_IP(1), type: IP(800), hop: 255, ver: 1
*Feb 14 21:44:08.391:      shtl: 4(NSAP), sstl: 0(NSAP)
*Feb 14 21:44:08.395:      pktsz: 84 extoff: 68
*Feb 14 21:44:08.395:  (M) traffic code: redirect(0)
*Feb 14 21:44:08.395:      src NBMA: 10.10.10.10
*Feb 14 21:44:08.399:      src protocol: 10.100.100.1, .dst protocol: 10.100.100.7
*Feb 14 21:44:08.403:      Contents of nhrp traffic indication packet:
*Feb 14 21:44:08.403:         45 00 00 64 00 50 00 00 FE 01 DF 71 0A 64 64 07
...
On the NHS:

HUB#debug dmvpn all all
...
*Feb 14 21:30:56.151: NHRP RIB_RWATCH: Debugging is ON
HUB#
*Feb 14 21:31:07.663: NHRP: Tunnels gave us remote_nbma: 7.7.7.7 for Redirect
*Feb 14 21:31:07.663: NHRP: Attempting to Redirect, remote_nbma: 7.7.7.7
*Feb 14 21:31:07.663: NHRP: inserting (7.7.7.7/10.100.100.8) in redirect table
*Feb 14 21:31:07.667: NHRP-ATTR:  Requester Ext Len: Total ext_len  with NHRP attribute VPE 16
...
Routing in DMVPN
DMVPN was developed by Cisco Systems with EIGRP in mind, as a routing protocol. To fully utilise the features of DMVPN, EIGRP is recommended as the routing protocol of the overlay network. However, other routing protocols such as OSPF, RIP, IS-IS can be used as routing protocols as well in DMVPN configurations.

If using EIGRP for the internal networks, split horizon needs to be disabled on the tunnel interface.

As EIGRP always maintain loop-free routes using the feasibility condition, disabling split-horizon does not introduce loops. However, it might be preferrable to disable it entirely.

HUB#configure terminal
HUB(config)#interface tunnel 10
HUB(config-if)#no ip split-horizon eigrp 100
HUB(config-if)#no ip next-hop-self eigrp 100
When configuring a routing protocol over the overlay network, never advertise the underlay network in routing protocol over the overlay network.

Verification of DMVPN
Viewing DMVPN Tunnel States
The Tunnel interface experiences varying states based on the stage of tunnel creation or if the tunnel experienced problems during establishment or operation. Addition of encryption to the tunnel also affects the state of the DMVPN tunnels. The commands to display the tunnel state are;

HUB#show dmvpn interface [detail] 
and
HUB#show dmvpn [detail]
This command displays tunnel interface, role, state, peers and uptime.

Tunnel states
INTF: Line protocol of DMVPN tunnel is down

IKE: DMVPN tunnels configured with IPSec have not yet successfully established an IKE session.

IPSec: An IKE session is established but an IPSec SA has not yet been established.

NHRP: The DMVPN spoke router has not yet successfully registered.

Up: Spoke has registered with hub and received ACK (positive registration reply). An up state must be maintained for traffic to flow. #show dmvpn detail includes local tunnel and NBMA ip addresses, tunnel health monitoring and VRF contexts IPSec crypto info is displayed.

HUB#show dmvpn detail
Legend: Attrb --> S - Static, D - Dynamic, I - Incomplete
        N - NATed, L - Local, X - No Socket
        # Ent --> Number of NHRP entries with same NBMA peer
        NHS Status: E --> Expecting Replies, R --> Responding, W --> Waiting
        UpDn Time --> Up or Down Time for a Tunnel
==========================================================================

Interface Tunnel0 is up/up, Addr. is 10.100.100.1, VRF ""
   Tunnel Src./Dest. addr: 10.10.10.10/MGRE, Tunnel VRF ""
   Protocol/Transport: "multi-GRE/IP", Protect ""
   Interface State Control: Disabled
   nhrp event-publisher : Disabled
Type:Hub, Total NBMA Peers (v4/v6): 2

# Ent  Peer NBMA Addr Peer Tunnel Add State  UpDn Tm Attrb    Target Network
----- --------------- --------------- ----- -------- ----- -----------------
    1 7.7.7.7            10.100.100.7    UP 01:18:58    D    10.100.100.7/32
    1 8.8.8.8            10.100.100.8    UP 01:09:17    D    10.100.100.8/32


Crypto Session Details:
--------------------------------------------------------------------------------

Pending DMVPN Sessions:

HUB#show dmvpn interface tunnel 0 detail
Legend: Attrb --> S - Static, D - Dynamic, I - Incomplete
        N - NATed, L - Local, X - No Socket
        # Ent --> Number of NHRP entries with same NBMA peer
        NHS Status: E --> Expecting Replies, R --> Responding, W --> Waiting
        UpDn Time --> Up or Down Time for a Tunnel
==========================================================================

Interface Tunnel0 is up/up, Addr. is 10.100.100.1, VRF ""
   Tunnel Src./Dest. addr: 10.10.10.10/MGRE, Tunnel VRF ""
   Protocol/Transport: "multi-GRE/IP", Protect ""
   Interface State Control: Disabled
   nhrp event-publisher : Disabled
Type:Hub, Total NBMA Peers (v4/v6): 2

# Ent  Peer NBMA Addr Peer Tunnel Add State  UpDn Tm Attrb    Target Network
----- --------------- --------------- ----- -------- ----- -----------------
    1 7.7.7.7            10.100.100.7    UP 01:19:31    D    10.100.100.7/32
    1 8.8.8.8            10.100.100.8    UP 01:09:50    D    10.100.100.8/32

HUB#
Viewing the NHRP Cache
#show ip nhrp (brief | detail) displays the local NHRP cache. The detail keyword lists routers that submitted an NHRP request and its request ID. The NHRP cache displays NHRP mapping entries and NHRP message flags.

SPOKE8#show ip nhrp detail                                              
10.100.100.1/32 via 10.100.100.1                                        
   Tunnel0 created 01:22:00, never expire                               
   Type: static, Flags: used                                            
   NBMA address: 10.10.10.10                                            
10.100.100.7/32 via 10.100.100.7                                        
   Tunnel0 created 01:21:58, expire 00:38:02                            
   Type: dynamic, Flags: router used                                    
   NBMA address: 7.7.7.7
The local NHRP cache contains

Network entry for hosts (/32 or 128) or subnets (/24, /25, /16) and tunnel to NBMA address

Interface number, duration of tunnel existence. Included is the amount of time to expiry of the tunnel for dynamic entries. Static entries do not expire.

NHRP mapping types;

Static: an entry created statically, on tunnel interface

Dynamic: an entry created from a spoke that register

Incomplete: a temporary entry placed locally while an NHRP resolution request is processing.

Local: a typical entry is of a local network that was advertised for an NHRP resolution reply.

(no socket): These mapping entries do not have an associated IPSec socket and encryption isn’t triggered yet.

NBMA address: transport IP address where the entry was received.

NHRP message flags specify attributes of an NHRP cache entry or of the peer for which the entry was created.

Used: this NHRP mapping was used to forward data packets within last 60 seconds.

Implicit: Mapping entry was learned implicitly for example source mapping information gleaned from an NHRP resolution request was received by local router or forwarded through local router.

Unique: This mapping entry must be unique and can’t be overwritten with a mapping entry that has the same tunnel IP address but different NBMA address.

Router: mapping entry is from a remote router that provides access to a network or host behind the remote router.

Rib: mapping entry has a corresponding routing entry in the routing table [H]

Nho: mapping entry has a corresponding path overriding the next hop for a remote network as installed by another routing protocol.

Nhop: Mapping entry for remote next hop address for remote tunnel interface and its associated NBMA address.

Tuning DMVPN Operation
Unique IP NHRP Registration
During registration, NHCs instruct NHS to keep their NBMA address unique. If a loss of connectivity occurs between the NHC and NHS and a new NBMA address is given to the NHC, say through DHCP, before the NHRP NHC cache timeout, the new registration is blocked. This can be overcome, by using the command; #ip nhrp registration no-unique on the NHC tunnel interface. Verify using the command #show ip nhrp 10.100.100.8

NHRP Route Table Manipulation
NHRP manipulates the routing table as necessary. An installed route is indicated by the code ‘H’. A next hop override is indicated by the code ‘%’. To display explicit NHRP shortcuts, #show ip route next-hop-override. The shortcut has a symbol ‘NHO and has a lower metric (255).

NHRP Route Table Manipulation with Summarisation
When summary routes are configured on routers the summary routes hide network convergence. The summary route is installed on the NHS tunnel IP (through EIGRP) and advertised to spokes. This reduces the unnecessary traffic entering the tunnel as remote NHCs do not have to receive the EIGRP updates or queries on routes internal to the NHS subnet. Also, convergence in the internal subnets of NHCs do not get sent to other NHCs by the NHSs.

When an NHRP redirect occurs, NHRP will install a more specific route to the remote NHC hence no NHO occurs.

Both entries in #show dmvpn detail will be DT1 and not DT2 showing no next-hop-override occurs.

Problems with Overlay Networks
Recursive Routing Problems
This happens when the transport/NBMA network is advertised into the same routing protocol that runs on the overlay network. One of the main preconditions for recursive routing is the routing protocol in the overlay network having a lower Administrative Distance (AD) than the routing protocol being used in the underlay network. An example of this can be where EIGRP is running on the overlay network and OSPF in the underlay network.

The two routers that have a DMVPN tunnel formed will share their routes using the EIGRP over the tunnel. EIGRP having an AD (90) lower than OSPF (110) will have its underlay route selected as the preferred route over the OSPF route by the remote router. This remote router will attempt to route underlay traffic through the tunnel. This will obviously fail. As it keeps attempting to route underlay traffic through the tunnel, the OSPF neighborship in the underlay network times out and gets terminated. As the router loses the tunnel, it creates a new OSPF neighborship with its underlay neighbor resulting in the reformation of the tunnel. Then EIGRP sends the same update of the underlay network across the tunnel. This process repeats continuously.

Removing the transport network from the overlay routing protocol resolves recursive routing

Outbound Interface Selection
Given two uplinks with two different routes, which interface to use for sending tunnel traffic?

Front-Door Virtual Route Forwarding (FVRF)
A DMVPN tunnel source or destination can be made to be separate from the DMVPN tunnel itself. The VRF associated with the transport network is known as front-foor VRF. Using a front-door VRF for every DMVPN tunnel prevents route recursion because the transport and overlay networks remain in separate routing tables. The transport network and interface can be associated with the transport VRF and the tunnel network and interface associated with the tunnel VRF.

Configuring FVRF
The VRF can be created using the older global configuration command #ip vrf vrf_name or the newer global configuration command #vrf definition vrf_name which supports IPv6 in addition to support for IPv4 through address families.

Step 1: Create the front-door VRF; # ip vrf vrf_name.If configuring IPv6 FVRFs, use the command vrf definition vrf_name as it is the only command of the two that supports IPv6.

Step 2: Associate the front-door FVRF to the interface; #vrf forwarding vrf_name

Step 3: Configure an IP address on the interface or sub-interface

Step 4: Make the DMVPN VRF-aware: #tunnel vrf fvrf_name

FVRF interfaces with static IP addressing require only a static default route in the FVRF context. Interfaces that receive addresses through DHCP do not require the configuration of a static route.

DMVPN Failure Detection and High Availability
By default, an NHRP mapping stays in the NHRP cache for 7200 seconds (2 hours) (holdtime). It can be modified to the recommended value of 600 seconds using the tunnel configuration command ip nhrp holdtime (1 – 65535).

NHRP registration packets are sent every NHRP timeout period. If no registration reply is received, a new registration packet is sent with a delay of 1 second, second packet is delayed for two seconds and third four seconds. NHS is declared down after third attempt. Use the enable command show dmvpn to confirm.

Periodic NHRP registration requests by spokes refresh the NHRP timeout period. In spoke to spoke tunnels, if tunnel is not used in two minutes of expiry time, it is torn down.

Probe state: NHCs attempting to register with a down NHS start sending probe packets periodically to determine the availability of the NHS. The delay in probe packets is 1, 2, 4, 8, 16, 32, 64. After 64 seconds, no more probe packets are sent. This can be verified by debug statetements;

. . . 
*Feb 14 21:55:12.391: NHRP-RATE: Sending initial Registration Request for 10.100.100.1, reqid 2
*Feb 14 21:55:14.303: NHRP: Setting retrans delay to 4 for nhs  dst 10.100.100.1
*Feb 14 21:55:14.307: NHRP-ATTR:  Requester Ext Len: Total ext_len  with NHRP attribute VPE 40

*Feb 14 21:55:14.307: NHRP: Attempting to send packet via DEST 10.100.100.1
*Feb 14 21:55:14.311: NHRP: NHRP successfully mapped '10.100.100.1' to NBMA 10.10.10.10
*Feb 14 21:55:14.315: NHRP: Encapsulation succeeded.  Sending NHRP Control Packet  NBMA Address: 10.10.10.10
*Feb 14 21:55:14.319: NHRP: Send Registration Request via Tunnel0 vrf 0, packet size: 92
*Feb 14 21:55:14.323:  src: 10.100.100.9, dst: 10.100.100.1
*Feb 14 21:55:14.327:  (F) afn: AF_IP(1), type: IP(800), hop: 255, ver: 1
*Feb 14 21:55:14.327:      shtl: 4(NSAP), sstl: 0(NSAP)
*Feb 14 21:55:14.331:      pktsz: 92 extoff: 52
*Feb 14 21:55:14.331:  (M) flags: "unique nat ", reqid: 2
*Feb 14 21:55:14.331:      src NBMA: 9.9.9.9
*Feb 14 21:55:14.335:      src protocol: 10.100.100.9, dst protocol: 10.100.100.1
*Feb 14 21:55:14.339:  (C-1) code: no error(0)
*Feb 14 21:55:14.339:        prefix: 32, mtu: 17912, hd_time: 7200
*Feb 14 21:55:14.343:        addr_len: 0(NSAP), subaddr_len: 0(NSAP), proto_len: 0, pref: 0
*Feb 14 21:55:14.343: Responder Address Extension(3):
*Feb 14 21:55:14.343: Forward Transit NHS Record Extension(4):
*Feb 14 21:55:14.347: Reverse Transit NHS Record Extension(5):
*Feb 14 21:55:14.347: NAT address Extension(9):
*Feb 14 21:55:14.347:  (C-1) code: no error(0)
*Feb 14 21:55:14.351:        prefix: 32, mtu: 17912, hd_time: 0
*Feb 14 21:55:14.351:        addr_len: 4(NSAP), subaddr_len: 0(NSAP), proto_len: 4, pref: 0
*Feb 14 21:55:14.351:        client NBMA: 10.10.10.10
*Feb 14 21:55:14.355:        client protocol: 10.100.100.1
*Feb 14 21:55:14.355: NHRP: 120 bytes out Tunnel0
*Feb 14 21:55:14.359: NHRP-RATE: Retransmitting Registration Request for 10.100.100.1, reqid 2, (retrans ivl 4 sec)
*Feb 14 21:55:18.171: NHRP: NHS-DOWN: 10.100.100.1
*Feb 14 21:55:18.187: NHRP: Already pending Registration Request for NHS: 10.100.100.1
*Feb 14 21:55:18.191: NHRP: NHS 10.100.100.1 Tunnel0 vrf 0 Cluster 0 Priority 0 Transitioned to 'E' from 'E'

*Feb 14 21:55:18.191: NHRP: Setting retrans delay to 8 for nhs  dst 10.100.100.1
*Feb 14 21:55:18.195: NHRP-ATTR:  Requester Ext Len: Total ext_len  with NHRP attribute VPE 40
. . .
*Feb 14 21:55:18.251: NHRP-RATE: Retransmitting Registration Request for 10.100.100.1, reqid 2, (retrans ivl 8 sec)
*Feb 14 21:55:25.567: NHRP: Setting retrans delay to 16 for nhs  dst 10.100.100.1
*Feb 14 21:55:25.571: NHRP-ATTR:  Requester Ext Len: Total ext_len  with NHRP attribute VPE 40
. . . 
*Feb 14 21:55:25.623: NHRP-RATE: Retransmitting Registration Request for 10.100.100.1, reqid 2, (retrans ivl 16 sec)
*Feb 14 21:55:39.495: NHRP: Setting retrans delay to 32 for nhs  dst 10.100.100.1
. . . 
*Feb 14 21:55:39.551: NHRP-RATE: Retransmitting Registration Request for 10.100.100.1, reqid 2, (retrans ivl 32 sec)
*Feb 14 21:56:09.879: NHRP: Setting retrans delay to 64 for nhs  dst 10.100.100.1
*Feb 14 21:56:09.883: NHRP-ATTR:  Requester Ext Len: Total ext_len  with NHRP attribute VPE 40
Additional hubs can be added by additional mapping statements to the tunnel interface. A muti-hub topology increases redundancy and provides high availability. NHRP timeout period is one third of the holdtime period which is 2400 seconds. This can be changed with the command ip nhrp registration timeout 240.

IPv6 DMVPN Configuration
IPv6 commands are similar to IPv4 commands. To create mGRE tunnels;

SPOKE8(config-if)#tunnel mode gre multipoint ipv6
A unique IPv6 link-local address should be assigned to the tunnel inteface when the tunnelling protocol is IPv6. IPv6 routing protocols use link-local addresses to discover each other and install in the RIB.

IPv6 DMVPN Commands
#show ipv6 nhrp (brief|detail)

#show dmvpn [ipv6] [detail]

#show ipv6 nhrp traffic

#show ipv6 nhrp nhs detail

Step 3: Securing the DMVPN Tunnel with IPSec
Securing DMVPN tunnels is explained here.
