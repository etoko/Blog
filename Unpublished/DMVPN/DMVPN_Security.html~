<h1>Securing DMVPN Tunnels With IPSec, IKEv1 or IKEv2</h1>

<h1>Introduction andOverview</h1>
<p>
In unencrypted DMVPN packets, the original packets have GRE flags added to them, and then the new GRE
IP header is added for routing the packets through the transport (underlay) network. 
The GRE IP header adds an extra 20 bytes of overhead, and the GRE flags add an 
extra 4 bytes of overhead. These packets use the protocol field of GRE (47).
By default, GRE has no in-built security features to secure the data transiting 
the tunnel. IPSec is used to provide encryption, data integrity, replay protection 
features to GRE tunnels.
</p>
<p>
IPSec provides origin authentication, data confidentiality, data integrity, 
replay detection, periodic rekey, perfect forward secrecy.
IPSec security architecture is composed of the following;
<ul>
    <li>Security Protocols</li>
    <li>Security Associations</li>
    <li>Key Management</li>
</ul>
</p>
<h1>Security Protocols</h1>
<p>
Security protocols can be used individually or in combination. They include;
<ol type="a">
 <li><b>Authentication Header (AH):</b> AH provides data integrity, authentication, replay protection.</li>
 <li><b>Encapsulating Security Payload (ESP):</b> ESP provides data confidentiality, integrity, 
     authentication and replay protection.</li>
</ol>

<h1>Key Management</h1>
<p>
Internet Key Exchange (IKE) negotiates the IPSec security associations (SAs). 
This process requires that the IPSec systems first authenticate themselves to each
other and establish ISAKMP (IKE) shared keys. IPSec uses IKEv2 by default. IKEv2 
introduced Extensible Authentication Protocol (EAP) with reduction of bandwidth 
consumption, network address translation (NAT) and ability to detect whether a 
tunnel is still alive.
</p>

<h1>Security Associations</h1>
<p>
A security association (SA) is a relationship between two or more entities that
describes how the entities will use security services to communicate securely.
</p>
<p>
Security Associations (SA) contain agreed upon security parameters. The two main 
security associations that will be used by DMVPN to secure traffic are IKE SA and 
IPSec SA:
<ul>
 <li><b>IKE SA:</b> used for control plane functions like IPSec key management 
 and management of IPSec SAs.</li>
 <li><b>IPSec SA:</b> used for data plane functions to secure data transmitted 
 between two different sites. 
 IPSec SAs are unidirectional and require at least two IPSec SAs (one for inbound 
 traffic and another for outbout traffic) for a secure connection to a DMVPN peer.
 
 </li>
</ul>
There can only be one IKE SA between end point devices but multiple IPSec SAs 
can be established between the same two endpoint devices. 
</p>

<h1>IPSec DMVPN Tunnel Protection Modes</h1>
<p>
Traditional IPSec provides two modes of packet protection; tunnel and transport:
<ol>
    <li><b>Tunnel mode:</b> the entire original packet is encrypted and a new set
    of IPSec headers is added. For encrypted DMVPN packets that use ESP tunnel 
    mode, the original packets have the GRE flags added to them, and then the 
    new GRE IP header is added for routing the packets on the transport (underlay)
    network. That portion of the packets is encrypted, a signature for the encrypted 
    payload is added. Then a new IPSec IP header is added for routing the packets 
    on the transport (underlay) network. The GRE IP header adds an extra 20 bytes 
    of overhead, the GRE flags add an extra 4 bytes of overhead, the IPsec IP 
    header adds an extra 20 bytes of overhead, and depending on the encryption 
    mechanism, a varying amount of additional bytes are added for the encrypted signature. 
    These packets use the IP protocol field of ESP (50).
    <p>
    It is important to note that the use of IPsec tunnel mode for DMVPN networks
    does not add any perceived value and adds 20 bytes of overhead. It is 
    recommended that transport mode should be used for encrypted DMVPN tunnels.
    </p>
    <li><b>Transport mode:</b> In this mode, the packet payload is encrypted. 
    In this mode, the packet is routed based on the original IP headers. For 
    encrypted DMVPN packets that use ESP transport mode, the original packets have
    the generic routing encapsulation (GRE) flags added to them, and then that 
    portion of the packets is encrypted. A signature for the encrypted payload 
    is added, and then the GRE IP header is added for routing the packets on the 
    transport (underlay) network. The GRE IP header adds an extra 20 bytes of 
    overhead, the GRE flags add an extra 4 bytes of overhead, and depending on 
    the encryption mechanism, a varying amount of additional bytes are added for
    the encrypted signature. These packets use the protocol field of ESP (50).
</ol>

<h1>IPSec Tunnel Protection</h1>
<p>
Enabling IPsec protection on a DMVPN network requires that all devices enable IPsec 
protection. If some routers have IPsec enabled and others do not, devices will not
be able to establish a connection on the tunnel interfaces with each other.
</p>
<p>
Key management and IPSec parameter negotiation is implemented using IKEv1 or IKEv2.
IKEv1
</p>
<p>
Deploying IPsec tunnel protection using static pre-shared keys involves the creation of an: 
<ol>
 <li>ISAKMP policy</li>
 <li>ISAKMP key and addresses of remote hosts.</li>
 <li>IPSec transform set</li>
 <li>IPSec profile</li>
</ol>
</p>


<h2>IKEv1</h2>
<p>
Originally DMVPN tunnel protection was provided by IKEv1. The configuration of 
DMVPN tunnel protection using DMVPN follows:
</p>

<h3>Step 1: Create the IKEv1policy:</h3>
<p>
<ol>
<li><h4>Define an IKE policy</h4></li>
The IKE policy is configured using the command 
 <code><b>crypto isakmp policy &lt;1-10000&gt;</b></code> where 1-10000 is the 
 priority of the protection suite.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
      	<code style="font-size:110%">
HUB(config)#<b>crypto isakmp policy 100</b>
</code></div>
</p>
  
    <li><h4>Configure encryption method</h4></li>
<p>
The encryption method is usually any of the synchronous encryption algorithms 
aes, 3des or des: 
<code><b>encryption &lt;aes | 3des | des&gt; &lt;128-256&gt;</b></code>
<ul>
  <li>aes | 3des | des: are the synchronous encryption versions supported by the platform.</li>
  <li>128 - 256: the supported encryption key sizes.</li>
</ul>
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-isakmp)#<b>encryption aes 256</b>
</code></div>
</p>
<p>
256 is the size of the encryption key. More modern platforms support a larger 
key size.
</p>

<li><h4>Configure the authentication method</h4></li>
<p>
The authentication method can be either preshared keys or RSA-signatures: 
<code><b>authentication &lt;pre-share | rsa-encr | rsa-sig&gt;</b></code>.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-isakmp)#<b>authentication pre-share</b>
</code></div>
</p>

<li><h4>Configure the Diffie-Helman group for integrity</h4></li>
<p>
Define the diffie-helman group using the command 
<code><b>group &lt;1|14|15|16|19|2|20|21|24|5&gt;</b></code>. 
The Diffie-Hellman groups include the following; 
<ul>
  <li>Group 1 (768 bits)</li>
  <li>Group 14 (2048 bits)</li>
  <li>Group 15 uses 3072 bits</li>
  <li>Group 16 (4096 bits)</li> 
  <li>Group 19 (256 bit ecp)</li>
  <li>Group 2 (1024 bit)</li>
  <li>Group 20 (384 bit ecp)</li>
  <li>Group 21 (521 bit ecp)</li>
  <li>Group 24 (2048 bit, 256 bit subgroup)</li>
  <li>Group 5 (1536 bit)</li>
</ul>
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-isakmp)#<b>group 16</b>
</code></div>
</p>
<li><h4>Configure the hash function for data integrity</h4></li>
<p>
The hash algorithm provides a check for data integrity i.e, a check to ensure 
that the data was not altered in transit. The main hashing functions in use are MD5 
and the various versions of SHA i.e, SHA, SHA256, SHA384, SHA512. 
The command is <code><b>hash &lt;md5 | sha | sha256 | sha384 | sha512&gt;</b></code>.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config-isakmp)#<B>hash sha512</b>
</code></div>
</p>

</ol>
<h3>Step 2: Configure the IKEv2 key</h3>
<p>
The IKE key is defined using the command 
<code><b>crypto isakmp key &lt;password&gt; address &lt;ip_address&gt;</b></code>. Use of the address 0.0.0.0 0.0.0.0 
is not recommended as it allows a host with any IP address to connect. However, 
it may be helpful only when many spokes connect to the hub and administration 
overhead is high with managing this scalability. Otherwise, to add additional 
level of security, a key should be defined for each spoke whose IP address is 
explicitly configured.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config)#<b>crypto isakmp key simplesimple address 0.0.0.0</b>
</code></div>
</p>
<h3>Step 3: Configure an IPSec transform set</h3>
<ol>
<li><h4>Define the transform set and ESP or AH settings</h4>
<p>
Define the ESP authentication and ESP encryption or AH authentication algorithms
for encryption or authentication.
</p>
Here one SA is created for inbound traffic and one for outbound traffic to a 
DMVPN peer using the global configuration command; 
<code><b>crypto ipsec transform-set &lt;transform-set-tag&gt; [&lt;esp-encryption-function&gt; 
&lt;esp-authentication-function&gt; | &lt;ah-authentication&gt;]</b></code>.
</p>
<p>
The AH options available include the following:
<ul>
<li><b>ah-md5-hmac:</b>      AH-HMAC-MD5 transform                                </li>
<li><b>ah-sha-hmac:</b>      AH-HMAC-SHA transform                                </li>
<li><b>ah-sha256-hmac:</b>   AH-HMAC-SHA256 transform                             </li>
<li><b>ah-sha384-hmac:</b>   AH-HMAC-SHA384 transform                             </li>
<li><b>ah-sha512-hmac:</b>   AH-HMAC-SHA512 transform                             </li>
<li><b>comp-lzs:</b>         IP Compression using the LZS compression algorithm   </li>
</ul>
</p>
<p>
The ESP options include the following:
<ul>
<li><b>esp-3des:</b>         ESP transform using 3DES(EDE) cipher (168 bits)      </li>
<li><b>esp-aes :</b>         ESP transform using AES cipher                       </li>
<li><b>esp-des :</b>         ESP transform using DES cipher (56 bits)             </li>
<li><b>esp-gcm :</b>         ESP transform using GCM cipher                       </li>
<li><b>esp-gmac:</b>         ESP transform using GMAC cipher                      </li>
<li><b>esp-md5-hmac:</b>     ESP transform using HMAC-MD5 auth                    </li>
<li><b>esp-null:</b>         ESP transform w/o cipher                             </li>
<li><b>esp-seal:</b>         ESP transform using SEAL cipher (160 bits)           </li>
<li><b>esp-sha-hmac:</b>     ESP transform using HMAC-SHA auth                    </li>
<li><b>esp-sha256-hmac:</b>  ESP transform using HMAC-SHA256 auth                 </li>
<li><b>esp-sha384-hmac:</b>  ESP transform using HMAC-SHA384 auth                 </li>
<li><b>esp-sha512-hmac:</b>  ESP transform using HMAC-SHA512 auth                 </li>                                                                     
</ul>
</p>
<p>
If an encryption algorithm is configured, the key size should be defined. 
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config)#$<b>crypto ipsec transform-set DMVPN_IPSEC_TSET esp-aes esp-sha512-hmac</b>
</code></div>
</p>
</li>
<li><h4>Define the tunnel mode</h4>
<p>
tunnel mode can be transport or tunnel
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(cfg-crypto-trans)#<b>mode transport</b>
</code></div>
</p>
</li>
</ol>
<h3>Step 4 Create an IPSec profile</h3>
<p>
The IPsec profiile is created and the references the IPsec transform set previously 
defined.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config)#<b>crypto ipsec profile DMVPN_IPSEC_PROFILE  </b><br>
HUB(ipsec-profile)#<b>set transform-set DMVPN_IPSEC_TSET </b><br>
HUB(ipsec-profile)#<b>exit                               </b>
</code></div>
</p>
<h3>Step 5: Associate the DMVPN tunnel interface with the IPSec profile</h3>
<p>
To protect the tunnel using IPsec, reference the configured IPsec profile under 
the tunnel configuration using the command <code><b>
tunnel protection ipsec profile &lt;ipsec_profile_name&gt;</b></code>.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
HUB(config)#<b>interface tunnel 0</b><br>
HUB(config-if)#<b>tunnel protection ipsec profile DMVPN_IPSEC_PROFILE</b>
</code></div>
</p>
<p>
Step 1 - 5 configurations are common to both the hub and spoke. This is an example 
of the templating that can be used with DMVPN.

To configure a specific key for each spoke, enter the spoke address. This IP address 
should be the one configured on the interface that is defined as the tunnel source 
when configuring the DMVPN tunnel interface on the spoke. The hub and host must 
share the same key.
</p>

<h2>Verification</h2>
<p>
The following commands can be used to verify tunnel protection using IPsec:
<ul>
  <li><code><b>show dmvpn detail</b></code></li>
  <li><code><b>show crypto isakmp sa</b></code></li>
  <li><code><b>show crypto isakmp policy</b></code></li>
  <li><code><b>show crypto ipsec sa</b></code></li>
  <li><code><b>show crypto ipsec profile</b></code></li>
</ul>
</p>

<h3><code>show dmvpn detail</code></h3>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
 <code style="font-size:110%">
SPOKE2#<b>show dmvpn detail</b>                                                        <br>    
Legend: Attrb --&gt; S - Static, D - Dynamic, I - Incomplete                           <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N - NATed, L - Local, X - No Socket                                            <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Ent --&gt; Number of NHRP entries with same NBMA peer                        <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NHS Status: E --&gt; Expecting Replies, R --&gt; Responding, W --&gt; Waiting  <br>      
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UpDn Time --&gt; Up or Down Time for a Tunnel                                  <br>
==========================================================================             <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                       <br>
Interface Tunnel0 is up/up, Addr. is 172.30.1.2, VRF ""                                <br>
&nbsp;&nbsp; Tunnel Src./Dest. addr: 99.255.30.1/MGRE, Tunnel VRF ""                             <br>
&nbsp;&nbsp; Protocol/Transport: "multi-GRE/IP", Protect "DMVPN_IPSEC_PROFILE"                   <br>
&nbsp;&nbsp; Interface State Control: Disabled                                                   <br>
&nbsp;&nbsp; nhrp event-publisher : Disabled                                                     <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                       <br>
IPv4 NHS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                      <br>
172.30.1.1&nbsp;&nbsp;RE NBMA Address: 99.255.10.2 priority = 0 cluster = 0                      <br>
Type:Spoke, Total NBMA Peers (v4/v6): 4                                                <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                       <br>
# Ent&nbsp;&nbsp;Peer NBMA Addr Peer Tunnel Add State&nbsp;&nbsp;UpDn Tm Attrb&nbsp;&nbsp;&nbsp;&nbsp;Target Network           <br>
----- --------------- --------------- ----- -------- ----- -----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;1 99.255.10.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;172.30.1.1&nbsp;&nbsp;&nbsp;&nbsp;UP 03:15:04&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;172.30.1.1/32           <br>
&nbsp;&nbsp;&nbsp;&nbsp;1 99.255.30.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;172.30.1.2&nbsp;&nbsp;&nbsp;&nbsp;UP 00:48:01&nbsp;&nbsp;DLX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;172.30.1.2/32           <br>
&nbsp;&nbsp;&nbsp;&nbsp;1 99.255.60.6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;172.30.1.7&nbsp;&nbsp;&nbsp;&nbsp;UP 00:12:13&nbsp;&nbsp;&nbsp;&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;172.30.1.7/32           <br>
&nbsp;&nbsp;&nbsp;&nbsp;1 99.255.60.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;172.30.1.8&nbsp;&nbsp;&nbsp;&nbsp;UP 00:48:01&nbsp;&nbsp;&nbsp;&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;172.30.1.8/32           <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                       <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                       <br>
Crypto Session Details:                                                                <br>
--------------------------------------------------------------------------------       <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                       <br>
Interface: Tunnel0                                                                     <br>
Session: [0x680251DC]                                                                  <br>
&nbsp;&nbsp;IKEv1 SA: local 99.255.30.1/500 remote 99.255.10.2/500 Active                        <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Capabilities:(none) connid:1001 lifetime:20:44:52                            <br>
&nbsp;&nbsp;Crypto Session Status: UP-ACTIVE                                                     <br>
&nbsp;&nbsp;fvrf: (none), Phase1_id: 99.255.10.2                                                 <br>
&nbsp;&nbsp;IPSEC FLOW: permit 47 host 99.255.30.1 host 99.255.10.2                              <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Active SAs: 2, origin: crypto map                                              <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inbound:  #pkts dec'ed 2510 drop 0 life (KB/Sec) 4254210/2162                  <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Outbound: #pkts enc'ed 2578 drop 0 life (KB/Sec) 4254210/2162                  <br>
&nbsp;&nbsp; Outbound SPI : 0xB80CDF30, transform : esp-256-aes esp-sha512-hmac                  <br>
&nbsp;&nbsp;&nbsp;&nbsp;Socket State: Open                                                                 <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                       <br>
Interface: Tunnel0                                                                     <br>
Session: [0x68024FEC]                                                                  <br>
&nbsp;&nbsp;IKEv1 SA: local 99.255.30.1/500 remote 99.255.60.6/500 Active                        <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Capabilities:(none) connid:1004 lifetime:23:47:43                            <br>
&nbsp;&nbsp;IKEv1 SA: local 99.255.30.1/500 remote 99.255.60.6/500 Active                        <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Capabilities:(none) connid:1005 lifetime:23:47:43                            <br>
&nbsp;&nbsp;Crypto Session Status: UP-ACTIVE                                                     <br>
&nbsp;&nbsp;fvrf: (none), Phase1_id: 99.255.60.6                                                 <br>
&nbsp;&nbsp;IPSEC FLOW: permit 47 host 99.255.30.1 host 99.255.60.6                              <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Active SAs: 4, origin: crypto map                                              <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inbound:  #pkts dec'ed 1 drop 0 life (KB/Sec) 4608000/2866                     <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Outbound: #pkts enc'ed 1 drop 0 life (KB/Sec) 4608000/2866                     <br>
&nbsp;&nbsp; Outbound SPI : 0x5D0DE203, transform : esp-256-aes esp-sha512-hmac                  <br>
&nbsp;&nbsp;&nbsp;&nbsp;Socket State: Open                                                                 <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                       <br>
Interface: Tunnel0                                                                     <br>
Session: [0x680250E4]                                                                  <br>
&nbsp;&nbsp;IKEv1 SA: local 99.255.30.1/500 remote 99.255.60.2/500 Active                        <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Capabilities:(none) connid:1002 lifetime:23:11:55                            <br>
&nbsp;&nbsp;IKEv1 SA: local 99.255.30.1/500 remote 99.255.60.2/500 Active                        <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Capabilities:(none) connid:1003 lifetime:23:11:55                            <br>
&nbsp;&nbsp;Crypto Session Status: UP-ACTIVE                                                     <br>
&nbsp;&nbsp;fvrf: (none), Phase1_id: 99.255.60.2                                                 <br>
&nbsp;&nbsp;IPSEC FLOW: permit 47 host 99.255.30.1 host 99.255.60.2                              <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Active SAs: 4, origin: crypto map                                              <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inbound:  #pkts dec'ed 6 drop 0 life (KB/Sec) 4254542/718                      <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Outbound: #pkts enc'ed 6 drop 0 life (KB/Sec) 4254542/718                      <br>
&nbsp;&nbsp; Outbound SPI : 0xBB52CAA0, transform : esp-256-aes esp-sha512-hmac                  <br>
&nbsp;&nbsp;&nbsp;&nbsp;Socket State: Open                                                                 <br>
                                                                                       <br>
Pending DMVPN Sessions:                                                                <br>
                                                                                    
SPOKE2#                 
</code></div>
</p>

<h1>IKEv2</h1>
<p>
IKEv2 was developed to eliminate the weaknesses of IKEv1. Cryptographic functions
consume CPU resources, so the CPU should be protected by limiting the number of
packets required to process IKE establishment. CPU utilization increases to 
maintain SA state including negotiation of a session. If CPU utilization is high
(for any other reasons), a session that has been started may not complete due to 
limited CPU resources.
</p>
<p>
Deploying IPsec tunnel protection is with the use of a static pre-shared key involves the creation of an:
<ol>
 <li>IKEv2 keyring</li>
 <li>IKEv2 profile</li>
 <li>IPSec transform set</li>
 <li>IPSec profile</li>
</ol>
</p>

<h2>IKEv2 Keyring</h2>
<p>
The IKEv2 keyring is a repository of the pre-shared keys. In a keyring, it is 
possible to define which keys apply to which hosts. Identification of the password 
is based on the IP address of the remote router. The IKEv2 keyrong is created 
with the following steps:
</p>
<h3>Step 1: Define the keyring instance</h3>
<p>
It is created with the global configuration command crypto ikev2 keyring
</p>

<h3>Step 2: Create a peer name</h3>
<p>
Multiple peers can exist in a keyring. Each peer has a matching qualifier and 
can use a different password. The peer is created with the command peer peer_name.
</p>

<h3>Step 3: Identify the IP address for the peer</h3>
<p>
Multiple peers can reside in a keyring. The IP address is identified so that the
appropriate peer configuration is used based upon the remote device’s IP address. 
The command address network netmask defines the IP address/range. Though not
recommended for a production network, the value of 0.0.0.0 0.0.0.0 may be used to 
match against any peer. For IPv6, the address ::/0 matches any IPv6 address.
</p>

<h3>Step 4: Define a preshared key</h3>
<p>
Define the preshared key with pre-shared-key key.
</p>

<h2>IKEv2 Profile</h2>
<p>
IKEv2 profile is a collection of non-negotiable security parameters used during 
IKE security association. The IKEv2 profile is later associated with the IPSec
profile. Within the IKEv2 profile, local and remote authentication methods must
be defined as well as a match statement.
</p>
<h3>Step 1: Define the IKEv2 profile</h3>
<p>
It is defined with the global configuration command crypto ikev2 profile 
profile_name
</p>
<h3>Step 2:Identify the IP address for the remote router</h3>
<p>
the IP address must be identified for the initial IKEv2 session to establish.
The peer IP address is defined with the command match identity remote address 
ip_address. This can be 0.0.0.0 0.0.0.0 to match against any peer. For IPv6, it can be ::/0.
</p>

<h3>Step 3: (Optional) Configure the local router’s identity</h3>
<p>
the local router’s identity can be set based on an IP address with the command 
identity local address ip_address. A loopback address is recommended as it is 
always ‘up’. Note that the IP address configured here should match the IP address
used during the certificate registration. This step is really not needed with 
preshared key authentication but is very important in the deployment of public
key infrastructure.
</p>

<h3>Step 4: Identify the Front-door VRF (FVRF) for the tunnel end</h3>
<p>
if a front-door VRF is used on the DMVPN tunnel, then the FVRF must be associated 
to the IKEv2 profile with the command match fvrf vrf_name | any. Keyword any allows
any configured FVRF to be selected.
</p>

<h3>Step 5: Define the local authentication method</h3>
<p>
The authentication method must be defined for connection requests that are received 
by remote peers. The command authentication local pre-share | rsa-sig defines the 
local authentication. Only one local authentication can be selected. The pre-share
keyword is for pre-shared static keys and rsa-sig is used for certificate based 
authentication.
</p>

<h3>Step 6: Define the remote authentication method</h3>
<p>
The authentication method must be defined for connection requests that are sent
to remote peers. The command authentication remote pre-share | rsa-sig defines 
the remote authentication. The pre-share keyword is used for pre-shared static 
keys and rsa-sig is used for certificate-based authentication.
</p>

<h3>Step 7: Define the IKEv2 keyring (for preshared authentication)</h3>
<p>
preshared authentication requires that the IKEv2 keyring be associated to the 
IKEv2 profile. The command keyring local keyring_name associates the IKEv2 keyring.
</p>

<h1>IPSec Transform Set</h1>
<p>
The transform set identifies the security protocols for encrypting traffic (ESP) 
or protocols for authenticating the data (AH). The transform set is created with 
the following steps;
<h2>Step 1: Create the transform set and identify the transforms</h2>
<p>
Only one transform set can be selected for ESP encryption, ESP authentication, 
AH authentication using the command crypto ipsec transform-set transform_set_name 
esp-encryption esp-authentication ah-authentication
</p>

<h2>Step 2: Specify the Transform Set mode</h2>
<p>
the transform set mode is configured with mode transport | tunnel. Tunnel mode 
is the default mode. However, it adds 20bytes of additional IPSec header to the 
overall packet. I’d personally recommend use of the transport mode.

<h1>IPSec Profile</h1>
<p>
The IPSec profile combines the IPSec transform set and the IKEv2 profile. The 
IPSec profile is created with the following steps;
</p>

<h2>Step 1: Create the IPSec profile</h2>
<p>
use the command crypto ipsec profile profile_name
</p>

<h2>Step 2: Specify the transform set</h2>
<p>
The transform set is specified with the command set transform-set transform-set-name
</p>

<h2>Step 3: Specify the IKEv2 profile</h2>
<p>
the IKEv2 profile is specified with the command set ikev2-profile ike2-profile-name
</p>

<h2>Verification</h2>
<p>
show crypto ipsec profile
</p>

<h1>Securing the DMVPN Tunnel</h1>
<p>
To secure the DMVPN tunnel, the IPSec profile should be associated with the DMVPN 
tunnel interface with the command; tunnel protection ipsec profile profile_name 
[shared]. The shared keyword is required for routers that terminate multiple secured
DMVPN tunnels on the same transport interface. The command shares the IPSec security
association database (SADB) among multiple DMVPN tunnels. Because the SADB is 
shared, a unique tunnel key must be defined on each DMVPN tunnel interface to 
ensure that the encrypted/decrypted traffic aligns to the proper DMVPN tunnel.
</p>

<h2>Protection and Optimisation of DMVPN Tunnel</h2>

<h3>Protection of IKEv2</h3>
<p>
The command crypto ikev2 limit max-in-negotiation-sa limit | max-sa limit outgoing 
limits the number of sessions being established or that are allowed to establish.
<ul>
    <li><b>Max-sa:</b> limits the total count of SAs that a router can establish 
    under normal conditions. The value should be set to double the number of ongoing 
    sessions in order to achieve renegotiation.</li>
    <li><b>Max-in-negotiation-sa:</b> limits the number of SAs being negotiated 
    at any one time.</li>
</ul>
<p>
To protect the IKE from half open sessions, a cookie can be used to validate that
sessions are valid IKEv2 sessions and not a Denial of Service (DoS) attack. The 
command crypto ikev2 cookie-challege challenge-number defines the threshold of 
half-open SAs before issuing an IKEv2 challenge.
</p>
<h3>Verification</h3>
<p>                                                                
show crypto ikev2 stats
</p>

<h2>IPSec Packet Replay Protection</h2>
<p>
The IPSec implementation includes an anti-replay mechanism that prevents intruders 
from duplicating encrypted packets by assigning a unique sequence number to each 
encrypted packet. When a router decrypts the IPSec oackets, it keeps track of the 
packets it has received. The IPSec anti-replay service rejects (discards) duplicate packets or old packets.
</p>
<p>
The router identifies acceptable packet age according to the following logic;
the router maintains a sequence number window size (default of 64 packets). 
The minimum sequence number is defined as the highest sequence number for a packet 
minus the window size. A packet is considered of age when the sequence number is 
between the minimum sequence number and the highest sequence number.
</p>
<p>
At times, the default 64-packet window size is not adequate. Encryption is where
the sequence number is set and this happens before any Quality of Server (QoS) 
policies are processed. Packets can be delayed because of QoS priorities, 
resulting in out-of-order packets where low-priority packets are queued, whereas 
high-priority packets are immediately forwarded. The sequence number increases 
on the receiving router because the high-priority packets shift the window ahead 
and when the lower priority packets arrive, they are discarded.
</p>
<p>
Increasing the anti-replay window size does not impact throughput or security.
An additional 128 bytes per incoming IPSec SA are needed to store the sequence 
number on the decryptor. The window size is increased globally with the command 
crypto ipsec security-association replay window-size size. Cisco recommends using 
the largest window size possible for the hardware. Usually it is 1024.
</p>

<h2>Dead Peer Detection (DPD)</h2>
<p>
When two routers establish an IPSec VPN tunnel between them, it is possible that
connectivity between the two routers can be lost for some reason. In most scenarios,
IKE and IPSec do not natively detect a loss of peer connectivity, which results in 
network traffic being black-holed until the SA lifetime expires.
</p>
<p>
The use of dead peer detection (DPD) helps detect the loss of connectivity to a 
remote IPSec peer. When DPD is enabled in on-demand mode, the two routers check 
for connectivity only when traffic needs to be sent and the peer’s liveliness is
questionable. In such scenarios, the router sends a DPD R-U-THERE request to query 
the status of the remote peer. If the remote peer does not respond, the requesting 
router starts to transmit additional R-U-THERE messages every retry interval for a 
maximum of five retries. If no response is received, that peer is declared dead.
</p>
<p>
DPD is configured with the command crypto ikev2 dpd interval-time retry-time 
on-demand in the IKEv2 profile. It is recommended that the interval time be set 
to twice that of the routing protocol hold time.
<p>
<p>
As it consumes CPU, it is recommended that DPD be configured on the spokes and 
not on the hubs because a hub may have to maintain state of hundreds of branch routers.
</p>

<h2>Network Address Translation (NAT) Keepalives</h2>
<p>
NAT keepalives are enabled to keep the dynamic NAT mapping alive during a 
connection between two peers. NAT keepalives are UDP packets that contain an 
unencrypted payload of 1 byte. When DPD is used to detect peer liveliness, NAT 
keepalives are sent if the IPSec entity has not transmitted or received a packet
within a specified period of time. It is configured on sopes because the routing
protocol messages such as Hello and update messages between the hub and spoke 
keeps the NAT state active whereas spoke to spoke tunnels do not maintain a 
routing neighborship so NAT state is not maintained. NAT keepalives are enabled 
with the command crypto isakmp nat keepalive seconds.
</p>

<h1>Verification of DMVPN Tunnel Security</h1>
<h2>show dmvpn detail</h2>
<p>
Output lists the status of the tunnel
</p>
<h2>show crypto ipsec sa</h2>
<p>

</p>