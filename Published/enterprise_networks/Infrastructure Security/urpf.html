 <h1>Overview</h1>
<p>
Unicast Reverse Path Forwarding (uRPF) is used to limit malicious traffic in
a network by blocking packets transiting a router having unknown source IP addresses. 
The design intention of uRPF is to block IP packets with spoofed or malformed
source IP addresses. It does this by checking the source IP address of packets 
arriving on an interface and determining whether the network of the source IP 
address is reachable using Layer 2 information in the Forwarding Information Base
(FIB). The FIB is generated by Cisco Express Forwarding (CEF). If the network of 
the packet source IP address is not reachable, the packet is dropped.
</p>
<p>
When forwarding traffic, by default, routers check for the reachability of a destination 
IP address prior to forwarding IP packets. With uRPF, the router validates reachability 
of the source IP address as well. uRPF can also be configured to verify whether the 
interface through which the packets entering the router is what the router would
normally use to send traffic back to IP addresses in that network.

For uRPF to function, CEF must be enabled globally (using the global configuration 
command <code><b>ip cef</b></code>).
</p>

<h1>How uRPF Works</h1>
<p>
The uRPF feature helps to mitigate problems caused by the introduction of malformed
or forged/spoofed IP source addresses into a network by discarding IP packets that 
lack a verifiable IP source address. A number of common Denial-of-Service (DoS) 
attacks such as smurf attacks, tribal Flood Network (TFN) attacks take advantage 
of forged or rapidly changing source IP addresses.
</p>
<p>
uRPF depends on CEF being enabled because the lookup relies on the FIB which is 
generated by CEF. uRPF is an input function and is applied only on the input
interface of a router at the upstream end of a connection.
</p>
<p>
uRPF checks to see if any packet received at a router interface arrives on the 
best return path to the source of the packet. uRPF does this by carrying out a 
reverse lookup in the CEF table. If the packet is received from one of the reverse
path routes, the packet is forwarded as normal.
</p>
<p>
If a reverse path for the packet is not found, the packet is dropped or forwarded 
depending on whether an ACL is specified in the URF configuration.
</p>
<p>
With uRPF, all equal cost return paths are considered valid. uRPF works in cases 
where multiple return paths exist provided that each path is equal to others in 
terms of routing cost, i.e. number of hops, cost etc. and as long as the route 
is in the FIB. uRPF also functions where EIGRP variants are being used with unequal 
cost routes back to the packet source IP address.
</p>

<h1>Unicast RPF Operation Modes</h1>
<p>
uRPF operates in three modes; strict, loose and VRF modes. Some modes may not be 
available on some Cisco router models.
<ol>
    <li><b>Strict mode:</b> uRPF checks to ensure that the source IP address 
    is reachable based on the FIB table and the packet must also be arriving on 
    the same interface that the router would use to send traffic back to that IP
    address.
    Strict mode should only be used in conditions where no possibility of asynchronous 
    routing exists or else packets will be dropped. This is likely to occur in 
    BGP routing.</li>
    <li><b>Loose mode:</b> The router only verifies that the source IP address is
    reachable based on the FIB entry. The default route or route through the interface 
    Null0 are not included in this reachability check. If the route is not in the 
    RIB, the packet is dropped.</li>
    <li><b>VRF mode:</b> This mode is similar to loose mode operation but is 
    deployed in VRF environments. Interfaces in the same VRF as the receiving 
    interface are examined. This is commonly used in ISP networks for MPLS and BGP.</li>
</ol>
</p>

<p>
If an ACL is referenced in the uRPF configuration, it is checked when uRPF fails. 
If uRPF check fails and the packet is permitted by an ACL, it is transmitted. 
If the ACL is configured to block the traffic the packet is dropped after uRPF 
failure.
</p>

<h1>uRPF Configuration</h1>
<p>
uRPF is configured on the ingress interface using the command:
<code><b>ip verify unicast source reachable-via &lt;rx | any&gt; &lt;allow-default&gt; &lt;allow-self-ping&gt; &lt;ACL&gt;</b></code>
Where: 
<ul>
<li><b>rx:</b> enables strict mode</li>
<li><b>any:</b> enables loose mode</li>
<li><b>allow-default:</b> allows the use of a default route. 
By default, uRPF drops packets whose source IP address/network is reachable only 
via the default route. uRPF supports <code><b>allow-default</b></code> to accept 
a default route as a valid route.
It can be used in strict mode or loose mode.</li>
<li><b>allow-self-ping:</b> allows self-pinging when checking reachability of IP 
address. Cisco specifically discourages configuration of uRPF with allow-self-ping 
as it introduces security loopholes that can be leveraged for Denial of Service (DoS) attacks.</li>
</ul>
Do not configure strict mode on an uplink interface. Loose mode may be more appropriate in these case.
</p>

<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
  <code>
R1(config)#<b>interface g0/0</b><br>
R1(config-if)#<b>ip verify unicast source reachable-via any</b>
</code></div>
</p>

<h2>uRPF with Access Control Lists</h2>

<p>
To permit traffic that fails a uRPF check and is permitted by an access control list:
<ol>
  <li>Configure an access control list that permits traffic from the source network.</li>
  <li>Configure uRPF and reference the ACL.</li>
</ol>
</p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
  <code>
R2(config)#<b>ip access-list standard 10</b>                                                                     <br>
R2(config-std-nacl)#<b>10 permit 192.168.10.0 0.0.0.255 log</b>                                                  <br>
R2(config-if)#<b>ip verify unicast source reachable-via any 10</b>                                               <br>
------------------------------------                                                                      <br>
!R1                                                                                                       <br>
R1#<b>ping 192.168.23.2 source lo10</b>                                                                          <br>
Type escape sequence to abort.                                                                            <br>
Sending 5, 100-byte ICMP Echos to 192.168.23.2, timeout is 2 seconds:                                     <br>
Packet sent with a source address of 192.168.10.1                                                         <br>
.....                                                                                                     <br>
Success rate is 0 percent (0/5)                                                                           <br>
R1#                                                                                                       <br>
----------------------------------------------                                                            <br>
!R2                                                                                                       <br>
*Apr 15 23:32:22.939: %SEC-6-IPACCESSLOGNP: list 10 permitted 0 192.168.10.1 -> 192.168.23.2, 1 packet    <br>
*Apr 15 23:38:06.071: %SEC-6-IPACCESSLOGNP: list 10 permitted 0 192.168.10.1 -> 192.168.23.2, 4 packets   <br>
</code></div>
</p>

<h1>Verification</h1>
<p>
&nbsp;
</p>

<h2><code>show ip interface &lt;interface-id&gt;</code></h2>
<p>
The following information can be learned from the output of the command 
<code><b>show ip interface &lt;interface-id&gt;</b></code>: 
<ul>
  <li>The number of packets dropped by the action of uRPF.</li>
  <li>uRPF is confirmed as being operational</li>
  <li>The number of packets that were dropped by uRPF but permitted by an ACL</li>
</ul>
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
  <code>
R2#<b>show ip interface g0/0</b>                           <br>              
GigabitEthernet0/0 is up, line protocol is up              <br>       
&nbsp;&nbsp;Internet address is 192.168.1.2/30                       <br>       
&nbsp;&nbsp;Broadcast address is 255.255.255.255                     <br>       
&nbsp;&nbsp;Address determined by setup command                      <br>       
&nbsp;&nbsp;MTU is 1500 bytes                                        <br>       
&nbsp;&nbsp;Helper address is not set                                <br>       
&nbsp;&nbsp;Directed broadcast forwarding is disabled                <br>       
&nbsp;&nbsp;Multicast reserved groups joined: 224.0.0.5 224.0.0.6    <br>       
&nbsp;&nbsp;Outgoing access list is not set                          <br>       
&nbsp;&nbsp;Inbound  access list is not set                          <br>       
&nbsp;&nbsp;Proxy ARP is enabled                                     <br>       
&nbsp;&nbsp;Local Proxy ARP is disabled                              <br>       
&nbsp;&nbsp;Security level is default                                <br>       
&nbsp;&nbsp;Split horizon is enabled                                 <br>       
&nbsp;&nbsp;ICMP redirects are always sent                           <br>       
&nbsp;&nbsp;ICMP unreachables are always sent                        <br>       
&nbsp;&nbsp;ICMP mask replies are never sent                         <br>       
&nbsp;&nbsp;IP fast switching is enabled                             <br>       
&nbsp;&nbsp;IP fast switching on the same interface is disabled      <br>       
&nbsp;&nbsp;IP Flow switching is disabled                            <br>       
&nbsp;&nbsp;IP CEF switching is enabled                              <br>       
&nbsp;&nbsp;IP CEF switching turbo vector                            <br>       
&nbsp;&nbsp;IP CEF turbo switching turbo vector                      <br>       
&nbsp;&nbsp;IP multicast fast switching is enabled                   <br>       
&nbsp;&nbsp;IP multicast distributed fast switching is disabled      <br>       
&nbsp;&nbsp;IP route-cache flags are Fast, CEF                       <br>       
&nbsp;&nbsp;Router Discovery is disabled                             <br>       
&nbsp;&nbsp;IP output packet accounting is disabled                  <br>       
&nbsp;&nbsp;IP access violation accounting is disabled               <br>       
&nbsp;&nbsp;TCP/IP header compression is disabled                    <br>       
&nbsp;&nbsp;RTP/IP header compression is disabled                    <br>       
&nbsp;&nbsp;Policy routing is disabled                               <br>       
&nbsp;&nbsp;Network address translation is disabled                  <br>       
&nbsp;&nbsp;BGP Policy Mapping is disabled                           <br>       
&nbsp;&nbsp;<span style="background:#d3d3d3;">Input features: uRPF, MCI Check</span>                          <br>       
&nbsp;&nbsp;IPv4 WCCP Redirect outbound is disabled                  <br>       
&nbsp;&nbsp;IPv4 WCCP Redirect inbound is disabled                   <br>       
&nbsp;&nbsp;IPv4 WCCP Redirect exclude is disabled                   <br>       
&nbsp;&nbsp;<span style="background:#d3d3d3;">IP verify source reachable-via ANY, ACL 10</span>               <br>       
&nbsp;&nbsp; <span style="background:#d3d3d3;">5 verification drops</span>                                    <br>       
&nbsp;&nbsp; <span style="background:#d3d3d3;">5 suppressed verification drops</span>                         <br>       
&nbsp;&nbsp; 0 verification drop-rate
</code></div>   
</p>

<h2><code>show cef interface &lt;interface-id&gt;</code></h2>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
  <code>
R2#<b>show cef interface g0/0</b>                    <br>       
GigabitEthernet0/0 is up (if_number 4)               <br>
&nbsp;&nbsp;Corresponding hwidb fast_if_number 4               <br>
&nbsp;&nbsp;Corresponding hwidb firstsw-&gt;if_number 4           <br>
&nbsp;&nbsp;Internet address is 192.168.1.2/30                 <br>
&nbsp;&nbsp;ICMP redirects are never sent                      <br>
&nbsp;&nbsp;<span style="background:#d3d3d3;">Per packet load-sharing is disabled</span><br>
&nbsp;&nbsp;<span style="background:#d3d3d3;">IP unicast RPF check is enabled</span><br>
&nbsp;&nbsp;Input features: uRPF                               <br>
&nbsp;&nbsp;IP policy routing is disabled                      <br>
&nbsp;&nbsp;BGP based policy accounting on input is disabled   <br>
&nbsp;&nbsp;BGP based policy accounting on output is disabled  <br>
&nbsp;&nbsp;Hardware idb is GigabitEthernet0/0                 <br>
&nbsp;&nbsp;Fast switching type 1, interface type 27           <br>
&nbsp;&nbsp;IP CEF switching enabled                           <br>
&nbsp;&nbsp;IP CEF switching turbo vector                      <br>
&nbsp;&nbsp;IP CEF turbo switching turbo vector                <br>
&nbsp;&nbsp;IP prefix lookup IPv4 mtrie 8-8-8-8 optimized      <br>
&nbsp;&nbsp;Input fast flags 0x4000, Output fast flags 0x0     <br>
&nbsp;&nbsp;ifindex 4(4)                                       <br>
&nbsp;&nbsp;Slot  Slot unit 0 VC -1                            <br>
&nbsp;&nbsp;IP MTU 1500
</code></div>
</p>
<h2><code>show ip traffic </code></h2>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
  <code>
R2#<b>show ip traffic</b>                                                    <br>
IP statistics:                                                        <br>
&nbsp;&nbsp;Rcvd:&nbsp;&nbsp;739 total, 733 local destination                             <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 format errors, 0 checksum errors, 1 bad hop count          <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 unknown protocol, 0 not a gateway                          <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 security failures, 0 bad options, 0 with options           <br>
&nbsp;&nbsp;Opts:&nbsp;&nbsp;0 end, 0 nop, 0 basic security, 0 loose source route         <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 timestamp, 0 extended security, 0 record route             <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 stream ID, 0 strict source route, 0 alert, 0 cipso, 0 ump  <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 other                                                      <br>
&nbsp;&nbsp;Frags: 0 reassembled, 0 timeouts, 0 couldn't reassemble             <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 fragmented, 0 fragments, 0 couldn't fragment               <br>
&nbsp;&nbsp;Bcast: 0 received, 0 sent                                           <br>
&nbsp;&nbsp;Mcast: 712 received, 721 sent                                       <br>
&nbsp;&nbsp;Sent:&nbsp;&nbsp;749 generated, 55 forwarded                                  <br>
&nbsp;&nbsp;Drop:&nbsp;&nbsp;1 encapsulation failed, 0 unresolved, 0 no adjacency         <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 no route, <span style="background:#d3d3d3;">5 unicast RPF</span>, 0 forced drop                     <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 options denied                                             <br>
&nbsp;&nbsp;Drop:&nbsp;&nbsp;0 packets with source IP address zero                        <br>
&nbsp;&nbsp;Drop:&nbsp;&nbsp;0 packets with internal loop back IP address                 <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 physical broadcast                                         <br>
&nbsp;&nbsp;Reinj: 0 in input feature path, 0 in output feature path            <br>
</code></div>
</p>
<h2><code>show ip verify statistics</code></h2>
<p>
(Provides uRPF statistics on a PIX | ASA | FWSM firewall
</p>

<h1>Access Control Lists and Logging</h1>
<p>
If a packet fails the uRPF check, uRPF checks the linked ACL to see if the packet 
should be dropped (ACL deny statement) or forwarded (permit statement). Regardless
of whether the packet is dropped or forwarded, the packet is counted in global IP 
traffic statistics for unicast drops and in interface statistics for uRPF. To log 
uRPF events, specify the logging option for the ACL ACE. Using log info, administrators 
can view source addresses that are used in the attack, the time at which packets 
arrived on an interface.
</p>
<p>
<b>Note:</b> Logging uRPF events for attacks that have a high rate of forged 
packets can degrade performance of the device.

<h1>Per-Interface Statistics</h1>
<p>
Per-interface statistics allow tracking of uRPF drops and uRPF suppressed drops. 
These statistics help identify the interface that is the entry point of the attacks.
Unicast suppressed drops are the count of packets that failed uRPF check but were 
permitted by ACLs.
</p>
<p>
<div style="background-color:#f4f0ec; border-style:solid;border-width:1px;border-color:#D3D3D3">
  <code>
R2#<b>show ip interface g0/0</b>                           <br>              
GigabitEthernet0/0 is up, line protocol is up              <br>       
&nbsp;&nbsp;Internet address is 192.168.1.2/30                       <br>       
&nbsp;&nbsp;Broadcast address is 255.255.255.255                     <br>       
&nbsp;&nbsp;Address determined by setup command                      <br>       
&nbsp;&nbsp;MTU is 1500 bytes                                        <br>       
&nbsp;&nbsp;Helper address is not set                                <br>       
&nbsp;&nbsp;Directed broadcast forwarding is disabled                <br>       
&nbsp;&nbsp;Multicast reserved groups joined: 224.0.0.5 224.0.0.6    <br>       
&nbsp;&nbsp;Outgoing access list is not set                          <br>       
&nbsp;&nbsp;Inbound  access list is not set                          <br>       
&nbsp;&nbsp;Proxy ARP is enabled                                     <br>       
&nbsp;&nbsp;Local Proxy ARP is disabled                              <br>       
&nbsp;&nbsp;Security level is default                                <br>       
&nbsp;&nbsp;Split horizon is enabled                                 <br>       
&nbsp;&nbsp;ICMP redirects are always sent                           <br>       
&nbsp;&nbsp;ICMP unreachables are always sent                        <br>       
&nbsp;&nbsp;ICMP mask replies are never sent                         <br>       
&nbsp;&nbsp;IP fast switching is enabled                             <br>       
&nbsp;&nbsp;IP fast switching on the same interface is disabled      <br>       
&nbsp;&nbsp;IP Flow switching is disabled                            <br>       
&nbsp;&nbsp;IP CEF switching is enabled                              <br>       
&nbsp;&nbsp;IP CEF switching turbo vector                            <br>       
&nbsp;&nbsp;IP CEF turbo switching turbo vector                      <br>       
&nbsp;&nbsp;IP multicast fast switching is enabled                   <br>       
&nbsp;&nbsp;IP multicast distributed fast switching is disabled      <br>       
&nbsp;&nbsp;IP route-cache flags are Fast, CEF                       <br>       
&nbsp;&nbsp;Router Discovery is disabled                             <br>       
&nbsp;&nbsp;IP output packet accounting is disabled                  <br>       
&nbsp;&nbsp;IP access violation accounting is disabled               <br>       
&nbsp;&nbsp;TCP/IP header compression is disabled                    <br>       
&nbsp;&nbsp;RTP/IP header compression is disabled                    <br>       
&nbsp;&nbsp;Policy routing is disabled                               <br>       
&nbsp;&nbsp;Network address translation is disabled                  <br>       
&nbsp;&nbsp;BGP Policy Mapping is disabled                           <br>       
&nbsp;&nbsp;<span style="background:#d3d3d3;">Input features: uRPF, MCI Check</span>                          <br>       
&nbsp;&nbsp;IPv4 WCCP Redirect outbound is disabled                  <br>       
&nbsp;&nbsp;IPv4 WCCP Redirect inbound is disabled                   <br>       
&nbsp;&nbsp;IPv4 WCCP Redirect exclude is disabled                   <br>       
&nbsp;&nbsp;IP verify source reachable-via ANY, ACL 10               <br>       
&nbsp;&nbsp; <span style="background:#d3d3d3;">5 verification drops</span>                                    <br>       
&nbsp;&nbsp; <span style="background:#d3d3d3;">5 suppressed verification drops</span>                         <br>       
&nbsp;&nbsp; 0 verification drop-rate
</code></div>   
</p>

<h1>Implementing Unicast RPF</h1>
<p>
uRPF implementation principles;
<ol>
  <li>Packets must be received on an interface that has the best return path to 
  the source (symmetric routing). There must be a route entry in the FIB matching the
  route to the receiving interface. ACLs permit uRPF to be used when packets are 
  known to be arriving by specific, less optimal asymmetric input paths.</li>
  <li>IP source addresses at the receiving interface must match the routing entry
  for the interface.</li>
  <li>uRPF is an input function and is applied only on the input interface of a 
  router at the upstream end of the network. </li>
</ol>
    </p>

<h1>Where to use uRPF</h1>
<p>
uRPF does not inspect IP packets encapsulated in tunnels such as GRE, L2TP, PPTP.
Configure uRPF so that it processes network traffic only after tunneling and 
encryption headers have been stripped from the packets.

uRPF can be used in any single-homed environment (symmetric routing). In such a 
case, uRPF is best used at the network perimeter for Internet, intranet and extranet.

uRPF on an ingress interface from the Internet protects an enterprise from packets
with malformed or spoofed source IP addresses from the Internet. If implemented 
in an ISP, it protects the ISP from spoofed packets from an enterprise.
</p>


<h1>Optimizing uRPF with ACLs</h1>
<p>
To leverage the available features of routers in providing protection against 
source IP address spoofing, it is recommended uRPF be configured along with the following:
<ol>
  <li>Configure ACLs to drop IP packets that have invalid source addresses 
  (ingress filtering)</li>
  <li>Configure ACLs to permit packets that fail the uRPF checks to allow specific 
  traffic from known asymmetric routed sources.</li>
  <li>Configure ACLs to track uRPF events by adding the logging option to the ACL. 
  This logging of denied or forwarded (suppressed drops) can provide additional 
  information about network attacks.</li>
</ol>
</p>
<h1>Restrictions to uRPF</h1>
<p>
Basic restrictions to applying uRPF;
<ul>
 <li>Clients should not be multi-homed to the same router.</li>
 <li>Ensure that packets flowing up the link (to the Internet) match the route 
 advertised out the link.</li>
 <li>uRPF is available on platforms that support CEF.</li>
</ul>
uRPF is important particularly in ISPs.
</p>

